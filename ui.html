<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color Generator</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f7f7f7;
            color: #333;
            font-size: 12px;
            line-height: 1.4;
            overflow-x: hidden;
        }

        .container {
            padding: 16px;
            max-width: 100%;
        }

        .tab-navigation {
            display: flex;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .tab-btn {
            flex: 1;
            padding: 8px 8px;
            background: none;
            border: none;
            font-size: 9px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: #6c757d;
            text-align: center;
        }

        .tab-btn.active {
            background: white;
            color: #000;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .color-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .color-picker {
            width: 32px;
            height: 24px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            background: none;
        }

        .hex-input {
            flex: auto;
            padding: 4px 6px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-family: 'Monaco', monospace;
            font-size: 10px;
            text-transform: uppercase;
        }

        .mode-buttons {
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
        }

        .mode-btn {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: white;
            color: #666;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: #000;
            color: white;
            border-color: #000;
        }

        .action-btn {
            width: 100%;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 2px;
        }

        .btn-primary {
            background: #000;
            color: white;
        }

        .btn-primary:hover {
            background: #333;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #e0e0e0;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-success {
            background: #667EEA;
            color: white;
        }

        .btn-success:hover {
            background: #768ae5;
        }

        .color-grid {
            display: flex;
            flex-direction: column;
            gap: 3px;
            max-height: 300px;
            overflow-y: auto;
        }

        .color-row {
            display: flex;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            font-size: 9px;
        }

        .color-row.closest {
            border: 1.5px solid #000000;
        }

        .color-swatch {
            width: 28px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 8px;
            color: white;
            text-shadow: 0 0 2px rgba(0,0,0,0.3);
        }

        .color-info {
            flex: 1;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 6px;
        }

        .color-hex {
            font-family: 'Monaco', monospace;
            font-size: 9px;
            cursor: pointer;
            padding: 1px 3px;
            border-radius: 2px;
            transition: all 0.2s;
        }

        .color-hex:hover {
            background: #f0f8ff;
            transform: scale(1.05);
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 6px;
            border-radius: 4px;
            font-size: 10px;
            text-align: center;
            margin-top: 6px;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        /* ÌÜ§ Îß§Ïπ≠ Ïä§ÌÉÄÏùº */
        .reference-display {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: linear-gradient(145deg, #e8f5e8, #d4f4d4);
            border-radius: 6px;
            border-left: 3px solid #28a745;
            margin-bottom: 8px;
        }

        .reference-color {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .reference-info {
            flex: 1;
        }

        .reference-info h4 {
            font-size: 11px;
            color: #28a745;
            margin-bottom: 2px;
        }

        .reference-info p {
            font-size: 9px;
            color: #155724;
            margin: 0;
        }

        .tone-input-area {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #000;
            margin-bottom: 8px;
        }

        .tone-suggestions {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-top: 8px;
        }

        .tone-suggestion {
            background: white;
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
            border: 1px solid #e0e0e0;
        }

        .tone-suggestion:hover {
            border-color: #000;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .tone-color-display {
            width: 40px;
            height: 24px;
            border-radius: 4px;
            margin: 0 auto 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }

        .tone-suggestion-title {
            font-weight: 600;
            font-size: 10px;
            color: #333;
            margin-bottom: 3px;
        }

        .tone-suggestion-hex {
            font-family: 'Monaco', monospace;
            font-size: 9px;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .tone-suggestion-desc {
            font-size: 8px;
            color: #666;
            line-height: 1.2;
        }

        .info-box {
            background: #f0f0f0;
            border: 1px solid #c7c7c7;
            border-radius: 4px;
            padding: 12px;
            margin-top: 8px;
        }

        .info-box h5 {
            color: #000000;
            font-size: 10px;
            margin-bottom: 4px;
        }

        .info-box p {
            font-size: 9px;
            color: #888;
            margin: 0;
            line-height: 1.3;
        }

        /* Custom Theme Wizard Ïä§ÌÉÄÏùº */
        .wizard-progress {
            margin-bottom: 20px;
            padding: 0 4px;
        }

        .simple-progress-bar {
            display: flex;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-segment {
            flex: 1;
            background: #e0e0e0;
            margin-right: 2px;
            border-radius: 2px;
        }

        .progress-segment:last-child {
            margin-right: 0;
        }

        .progress-segment.active {
            background: #667eea;
        }

        .progress-segment.completed {
            background: #667eea;
        }

        .wizard-step {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .wizard-step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-header {
            text-align: left;
            margin-bottom: 20px;
            padding-left: 4px;
        }

        .step-header h2 {
            font-size: 16px;
            color: #333;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .step-header p {
            font-size: 11px;
            color: #888;
            margin: 0;
        }

        .step-content {
            margin-bottom: 24px;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            font-size: 11px;
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }

        .color-preview {
            margin-top: 6px;
        }

        .preview-swatch {
            width: 40px;
            height: 20px;
            border-radius: 3px;
            background: #667eea;
            border: 1px solid #ccc;
        }

        .token-preview {
            background: #f5f5f5;
            border-radius: 4px;
            padding: 12px;
        }

        .token-item {
            display: block;
            margin-bottom: 8px;
            padding: 0;
            border: none;
        }

        .token-item:last-child {
            margin-bottom: 0;
        }

        .token-label {
            font-size: 11px;
            color: #333;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .token-value {
            font-size: 11px;
            font-family: 'Monaco', monospace;
            color: #667eea;
            background: transparent;
            padding: 0;
            border-radius: 0;
            display: block;
        }

        .mode-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
            width: 100%;
            justify-content: center;
        }


        .mode-card {
            background: #ffffff;
            
            border-radius: 6px;
            box-sizing: border-box;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            width: 100%;
            height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
            overflow: hidden;
        }

        .mode-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-1px);
        }

        .mode-card.selected {
            border: 2px solid #000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .card-checkbox {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 28px;
            height: 28px;
            border-radius: 14px;
            background: #f7f7f7;
            border: 2px solid #ddd;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px;
            transition: all 0.2s;
            z-index: 10;
        }

        .mode-card.selected .card-checkbox {
            background: #1f1f1f;
            border: 2px solid #000;
        }

        .checkbox-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .checkbox-icon.unselected {
            opacity: 0.0;
        }

        .mode-card.selected .checkbox-icon.unselected {
            display: none;
        }
        
        /* ÏÉàÎ°úÏö¥ ÏïÑÏù¥ÏΩò Íµ¨Ï°∞ CSS */
        .mode-card .selected-icon {
            display: none !important;
        }
        .mode-card .unselected-icon {
            display: none !important;
        }
        .mode-card.selected .selected-icon {
            display: block !important;
        }
        .mode-card.selected .unselected-icon {
            display: none !important;
        }
        
        /* accent-on-bg-off Î™®Îìú Î∞∞Í≤ΩÏÉâ Ï†ÅÏö© */
        .mode-card[data-mode="accent-on-bg-off"] {
            background: #e8edff;
        }
        
        /* accent-off-bg-on Î™®Îìú Î∞∞Í≤ΩÏÉâ Ï†ÅÏö© */
        .mode-card[data-mode="accent-off-bg-on"] {
            background: #667eea;
        }
        .mode-card[data-mode="accent-off-bg-on"] .preview-frame {
            
        }
        .mode-card[data-mode="accent-off-bg-on"] .card-label {
            color: white;
        }
        
        /* accent-on-bg-black Î™®Îìú Î∞∞Í≤ΩÏÉâ Ï†ÅÏö© */
        .mode-card[data-mode="accent-on-bg-black"] {
            background: #1f1f1f;
        }
        .mode-card[data-mode="accent-on-bg-black"] .preview-frame {
            background: none !important;
        }
        .mode-card[data-mode="accent-on-bg-black"] .card-label,
        .mode-card[data-mode="accent-on-bg-black"] .card-sub-label {
            color: white;
        }

        .card-preview {
            
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            width: 100%;
        }

        .preview-frame {
            width: 100%;
            height: 100%;
            
            border-radius: 3px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            box-sizing: border-box;
        }

        
        .preview-frame.white-bg {
            
        
        }
        
        .preview-frame.black-bg {
            /* background removed */
        }

        .frame-header {
            font-size: 8px;
            font-weight: 600;
            color: #333;
            text-align: left;
            padding: 6px 8px;
            width : 100%;
            
            display: flex;
            justify-content: flex-start;
            align-items: center;
        }
        .frame-header svg path {
            fill: #000000;
            transition: fill 0.3s ease;
        }

        .frame-header.white {
            color: white;
        }


        .preview-frame.black-bg .frame-header {
            color: white;
            background: transparent;
            border-bottom-color: rgba(255,255,255,0.2);
        }

        .frame-content-area {
            padding: 4px;
            display: flex;
            gap: 2px;
            flex: 1;
            align-items: stretch;
        }

        .content-block {
            flex: 1;
            background: #f8f9fa;
            border-radius: 2px;
        }

        .content-block.light {
            background: #f8f9fa;
        }

        .content-block.white {
            background: rgba(255,255,255,0.8);
        }


        .preview-frame.black-bg .content-block.white {
            background: rgba(255,255,255,0.8);
        }

        .frame-button {
            background: #bcc8ff;
            border-radius: 3px;
            width: 100%;
            height: 20px;
            margin: 2px 4px 0;
            transition: background-color 0.3s ease;
        }

        .frame-button.accent {
            background: #667eea;
        }

        .frame-button.dark {
            background: #333;
        }

        .card-footer {
            text-align: center;
        }

        .card-label {
            font-size: 9px;
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
            transition: color 0.3s ease;
        }

        .card-sub-label {
            font-size: 9px;
            color: #777;
            line-height: 1.2;
            transition: color 0.3s ease;
        }

        .card-description {
            font-size: 9px;
            color: #777;
            line-height: 1.2;
        }

        /* ÏÉâÏÉÅ Î∂ÑÎ•ò Ï†ïÎ≥¥ Ïä§ÌÉÄÏùº */
        .color-classification-info {
            margin-top: 8px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #667eea;
            transition: all 0.3s ease;
        }

        .classification-badge {
            margin-bottom: 4px;
        }

        .classification-result {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        .classification-result.light {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .classification-result.dark {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .classification-details {
            font-size: 10px;
            color: #666;
            margin-bottom: 4px;
        }

        .classification-reasons {
            font-size: 9px;
            color: #888;
            font-style: italic;
            line-height: 1.2;
        }

        .color-classification-info.light {
            border-left-color: #ffc107;
            background: #fff9e6;
        }

        .color-classification-info.dark {
            border-left-color: #17a2b8;
            background: #e6f7ff;
        }

        .step-actions {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
        }

        .step-actions button {
            flex: 1;
            height: 32px;
            font-size: 11px;
        }

        .theme-preview {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }

        .theme-mode-preview {
            background: white;
            border-radius: 6px;
            padding: 8px;
            border: 1px solid #e0e0e0;
        }

        .theme-mode-title {
            font-size: 10px;
            font-weight: 600;
            margin-bottom: 6px;
            text-align: center;
        }

        .theme-semantic-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .semantic-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 8px;
        }

        .semantic-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .semantic-name {
            flex: 1;
            font-family: 'Monaco', monospace;
            color: #666;
        }

        .theme-name-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 11px;
            margin-bottom: 8px;
            background: white;
        }

        .theme-name-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }

        /* Radio Button Ïä§ÌÉÄÏùº */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 8px;
            background: rgba(255,255,255,0.5);
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .radio-option {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .radio-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .radio-option input[type="radio"] {
            margin-top: 2px;
        }

        .radio-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
            border-width: 2px;
        }

        .radio-content {
            flex: 1;
        }

        .radio-label {
            font-size: 10px;
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
            display: block;
        }

        .radio-hint {
            font-size: 8px;
            color: #666;
            line-height: 1.3;
        }

        .step-indicator {
            display: inline-block;
            padding: 4px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 6px;
        }

        .step-light {
            background: #fff3cd;
            color: #856404;
        }

        .step-dark {
            background: #343a40;
            color: #f8f9fa;
        }

        .classification-badge {
            display: inline-block;
            padding: 4px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 4px;
        }

        .classification-300 {
            background: #cfe2ff;
            color: #084298;
            border: 1px solid #b6d4fe;
        }

        .classification-400 {
            background: #f8d7da;
            color: #842029;
            border: 1px solid #f5c2c7;
        }

        .warning-box {
            background: #fff7dd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 8px 20px;
            margin-bottom: 8px;
        }

        .warning-box p {
            font-size: 9px;
            color: #856404;
            margin: 0;
        }

        /* ÏïÑÏΩîÎîîÏñ∏ Ïä§ÌÉÄÏùº Ï∂îÍ∞Ä */
        .accordion-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 12px;
        }

        .accordion-header:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .accordion-header.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .accordion-icon {
            font-size: 14px;
            transition: transform 0.2s;
        }

        .accordion-header.active .accordion-icon {
            transform: rotate(180deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .accordion-content.expanded {
            max-height: 2000px;
            transition: max-height 0.5s ease-in;
        }

        .accordion-body {
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 6px 6px;
            background: white;
        }

        #tuningSlider {
            width: 100%;
            -webkit-appearance: none;
            height: 4px;
            border-radius: 2px;
            background: #e0e0e0;
            outline: none;
        }

        #tuningSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        #tuningSlider:disabled {
            opacity: 0.5;
        }

        #tuningStatus {
            padding: 2px 6px;
            border-radius: 3px;
            background: #f0f0f0;
        }

        #tuningStatus.auto {
            background: #e8f5e8;
            color: #28a745;
        }

        /* ÏÉâÏÉÅ Î≥µÏÇ¨ Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes copyFlash {
            0% { 
                background: #4CAF50; 
                color: white;
                transform: scale(1.1);
            }
            100% { 
                background: transparent; 
                transform: scale(1);
            }
        }

        .color-hex.copied {
            animation: copyFlash 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
        <div class="tab-navigation">
            <button class="tab-btn active" id="customThemeTab">
                Custom Theme
            </button>
            <button class="tab-btn" id="generatorTab">
                Scale Generator
            </button>
            <button class="tab-btn" id="toneMatchingTab">
                Tone Matching
            </button>
        </div>

        <!-- Custom Theme ÌÉ≠ -->
        <div id="customThemeContent" class="tab-content active">
            <!-- ÌîÑÎ°úÍ∑∏Î†àÏä§ Î∞î -->
            <div class="wizard-progress">
                <div class="simple-progress-bar">
                    <div class="progress-segment active" data-step="1"></div>
                    <div class="progress-segment" data-step="3"></div>
                </div>
            </div>

            <!-- Step 1: Key Color ÏÑ†ÌÉù -->
            <div id="wizardStep1" class="wizard-step active">
                <div class="step-header">
                    <h2>Step 1. Key Color ÏÑ†ÌÉù</h2>
                    <p>ÏÑ†ÌÉùÌïú Key ColorÎ•º Í∏∞Î∞òÏúºÎ°ú ÏôÑÏ†ÑÌïú semantic ÌÜ†ÌÅ∞ ÏãúÏä§ÌÖúÏùÑ ÏÉùÏÑ±Ìï©ÎãàÎã§.</p>
                </div>
                
                <div class="step-content">
                    <div class="input-group">
                        <label>ÌÖåÎßà Ïù¥Î¶Ñ</label>
                        <input type="text" id="wizardThemeNameInput" class="theme-name-input" 
                               placeholder="Ïòà: custom-theme" value="custom-theme">
                    </div>
                    
                    <div class="input-group">
                        <label>Key Color</label>
                        <div class="color-input-group">
                            <input type="color" id="wizardThemeBaseColor" class="color-picker" value="#667eea">
                            <input type="text" id="wizardThemeBaseHex" class="hex-input" value="#667EEA">
                        </div>
                        
                        <!-- ÏÉâÏÉÅ Î∂ÑÎ•ò Ï†ïÎ≥¥ ÌëúÏãú -->
                        <div id="colorClassificationInfo" class="color-classification-info">
                            <div class="classification-badge">
                                <span id="classificationResult" class="classification-result">Ïñ¥ÎëêÏö¥ Î≤îÏúÑ</span>
                            </div>
                            <div id="classificationDetails" class="classification-details">
                                Î∞ùÍ∏∞: <span id="lightnessValue">50</span>% | ÏÉâÏ°∞: <span id="hueValue">240</span>¬∞
                            </div>
                            <div id="classificationReasons" class="classification-reasons"></div>
                        </div>
                    </div>
                </div>
                
                <div class="step-actions">
                    <button class="action-btn btn-primary" onclick="goToStep(3)">Îã§Ïùå</button>
                </div>
            </div>


            <!-- Step 3: Mode ÏÑ†ÌÉù Î∞è Ï†ÅÏö© -->
            <div id="wizardStep3" class="wizard-step">
                <div class="step-header">
                    <h2>Step 2. Mode ÏÑ†ÌÉù</h2>
                    <p>ÏÑ†ÌÉùÌïú FrameÏóê ThemeÏùÑ Ï†ÅÏö©Ìï©ÎãàÎã§.</p>
                </div>
                
                <div class="step-content">
                    <div class="mode-selection">
                        <div class="mode-cards">
                            <!-- Mode 1: forground Ï§ëÏã¨ -->
                            <div class="mode-card selected" data-mode="accent-on-bg-off">
                                <div class="card-checkbox">
                                    <svg class="checkbox-icon selected-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4.0332 10.0227L8.69951 15.0004L15.9589 5.03613" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    <svg class="checkbox-icon unselected-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: none;">
                                        <circle cx="10" cy="10" r="8" stroke="#ddd" stroke-width="2" fill="none"/>
                                    </svg>
                                </div>
                                <div class="card-preview">
                                    <div class="preview-frame">
                                        <div class="frame-header">
                                            <svg width="40" height="11" viewBox="0 0 60 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path fill-rule="evenodd" clip-rule="evenodd" d="M18.3088 0.55957C15.5807 0.55957 13.3688 2.70342 13.3688 5.34814C13.3688 7.92637 15.5253 10.0165 18.1852 10.0165C18.2997 10.0165 18.4097 10.0021 18.5197 9.98764C18.5724 9.98073 18.6251 9.97381 18.6783 9.96847L14.9751 15.1993H17.4012L22.4563 7.88935C22.973 7.14237 23.2492 6.25583 23.2492 5.34814C23.2492 2.70342 21.0375 0.55957 18.3088 0.55957ZM18.3088 8.30514C16.6757 8.30514 15.3518 6.98118 15.3518 5.34814C15.3518 3.71478 16.6757 2.39081 18.3088 2.39081C19.9418 2.39081 21.2658 3.71478 21.2658 5.34814C21.2658 6.98118 19.9418 8.30514 18.3088 8.30514Z" />
                                                <path d="M39.3951 4.05236C38.3724 3.02899 36.9648 2.39064 35.4071 2.39064C32.2922 2.39064 29.7579 4.92496 29.7579 8.03979C29.7579 11.1546 32.2922 13.6888 35.4071 13.6888C36.9648 13.6888 38.3724 13.0506 39.3951 12.0271L40.7388 13.3707C39.362 14.6942 37.4839 15.5183 35.4071 15.5183C31.1984 15.5183 27.7743 12.1633 27.7743 8.03979C27.7743 3.91633 31.1984 0.561317 35.4071 0.561317C37.4839 0.561317 39.362 1.38521 40.7388 2.70885L39.3951 4.05236Z" />
                                                <path d="M52.6666 7.91318L57.6453 0.879978H59.8262V15.1995H57.8408V3.90107L52.6666 11.3855L47.492 3.90107V15.1995H45.5068V0.879978H47.6878L52.6666 7.91318Z" />
                                                <path d="M4.5399 0.559586C7.0473 0.559586 9.07995 2.52526 9.07995 4.94999C9.07995 6.0115 8.67185 7.03231 7.94025 7.80124L2.64392 13.3682H9.07995V15.1993H0V13.3682L6.43603 6.60338C6.86032 6.15747 7.09681 5.56558 7.09681 4.94999C7.09681 3.53662 5.95214 2.39083 4.5399 2.39083C3.12781 2.39083 1.98298 3.53662 1.98298 4.94999H0C0 2.52526 2.03249 0.559586 4.5399 0.559586Z" />
                                            </svg>
                                        </div>
                                        <div class="frame-content-area">
                                            <div class="content-block light"></div>
                                            <div class="content-block light"></div>
                                        </div>
                                        <div class="frame-button accent"></div>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <div class="card-label">forground Ï§ëÏã¨</div>
                                </div>
                            </div>
                            
                            <!-- Mode 3: background Ï§ëÏã¨ -->
                            <div class="mode-card" data-mode="accent-off-bg-on">
                                <div class="card-checkbox">
                                    <svg class="checkbox-icon selected-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: none;">
                                        <path d="M4.0332 10.0227L8.69951 15.0004L15.9589 5.03613" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    <svg class="checkbox-icon unselected-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="10" cy="10" r="8" stroke="#ddd" stroke-width="2" fill="none"/>
                                    </svg>
                                </div>
                                <div class="card-preview">
                                    <div class="preview-frame">
                                        <div class="frame-header">
                                            <svg width="40" height="11" viewBox="0 0 60 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path fill-rule="evenodd" clip-rule="evenodd" d="M18.3088 0.55957C15.5807 0.55957 13.3688 2.70342 13.3688 5.34814C13.3688 7.92637 15.5253 10.0165 18.1852 10.0165C18.2997 10.0165 18.4097 10.0021 18.5197 9.98764C18.5724 9.98073 18.6251 9.97381 18.6783 9.96847L14.9751 15.1993H17.4012L22.4563 7.88935C22.973 7.14237 23.2492 6.25583 23.2492 5.34814C23.2492 2.70342 21.0375 0.55957 18.3088 0.55957ZM18.3088 8.30514C16.6757 8.30514 15.3518 6.98118 15.3518 5.34814C15.3518 3.71478 16.6757 2.39081 18.3088 2.39081C19.9418 2.39081 21.2658 3.71478 21.2658 5.34814C21.2658 6.98118 19.9418 8.30514 18.3088 8.30514Z" />
                                                <path d="M39.3951 4.05236C38.3724 3.02899 36.9648 2.39064 35.4071 2.39064C32.2922 2.39064 29.7579 4.92496 29.7579 8.03979C29.7579 11.1546 32.2922 13.6888 35.4071 13.6888C36.9648 13.6888 38.3724 13.0506 39.3951 12.0271L40.7388 13.3707C39.362 14.6942 37.4839 15.5183 35.4071 15.5183C31.1984 15.5183 27.7743 12.1633 27.7743 8.03979C27.7743 3.91633 31.1984 0.561317 35.4071 0.561317C37.4839 0.561317 39.362 1.38521 40.7388 2.70885L39.3951 4.05236Z" />
                                                <path d="M52.6666 7.91318L57.6453 0.879978H59.8262V15.1995H57.8408V3.90107L52.6666 11.3855L47.492 3.90107V15.1995H45.5068V0.879978H47.6878L52.6666 7.91318Z" />
                                                <path d="M4.5399 0.559586C7.0473 0.559586 9.07995 2.52526 9.07995 4.94999C9.07995 6.0115 8.67185 7.03231 7.94025 7.80124L2.64392 13.3682H9.07995V15.1993H0V13.3682L6.43603 6.60338C6.86032 6.15747 7.09681 5.56558 7.09681 4.94999C7.09681 3.53662 5.95214 2.39083 4.5399 2.39083C3.12781 2.39083 1.98298 3.53662 1.98298 4.94999H0C0 2.52526 2.03249 0.559586 4.5399 0.559586Z" />
                                            </svg>
                                        </div>
                                        <div class="frame-content-area">
                                            <div class="content-block white"></div>
                                            <div class="content-block white"></div>
                                        </div>
                                        <div class="frame-button dark"></div>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <div class="card-label">background Ï§ëÏã¨</div>
                                </div>
                            </div>
                            
                            <!-- Mode 2: forground Ï§ëÏã¨ white bg -->
                            <div class="mode-card" data-mode="accent-on-bg-fixed">
                                <div class="card-checkbox">
                                    <svg class="checkbox-icon selected-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: none;">
                                        <path d="M4.0332 10.0227L8.69951 15.0004L15.9589 5.03613" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    <svg class="checkbox-icon unselected-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="10" cy="10" r="8" stroke="#ddd" stroke-width="2" fill="none"/>
                                    </svg>
                                </div>
                                <div class="card-preview">
                                    <div class="preview-frame white-bg">
                                        <div class="frame-header">
                                            <svg width="40" height="11" viewBox="0 0 60 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path fill-rule="evenodd" clip-rule="evenodd" d="M18.3088 0.55957C15.5807 0.55957 13.3688 2.70342 13.3688 5.34814C13.3688 7.92637 15.5253 10.0165 18.1852 10.0165C18.2997 10.0165 18.4097 10.0021 18.5197 9.98764C18.5724 9.98073 18.6251 9.97381 18.6783 9.96847L14.9751 15.1993H17.4012L22.4563 7.88935C22.973 7.14237 23.2492 6.25583 23.2492 5.34814C23.2492 2.70342 21.0375 0.55957 18.3088 0.55957ZM18.3088 8.30514C16.6757 8.30514 15.3518 6.98118 15.3518 5.34814C15.3518 3.71478 16.6757 2.39081 18.3088 2.39081C19.9418 2.39081 21.2658 3.71478 21.2658 5.34814C21.2658 6.98118 19.9418 8.30514 18.3088 8.30514Z" />
                                                <path d="M39.3951 4.05236C38.3724 3.02899 36.9648 2.39064 35.4071 2.39064C32.2922 2.39064 29.7579 4.92496 29.7579 8.03979C29.7579 11.1546 32.2922 13.6888 35.4071 13.6888C36.9648 13.6888 38.3724 13.0506 39.3951 12.0271L40.7388 13.3707C39.362 14.6942 37.4839 15.5183 35.4071 15.5183C31.1984 15.5183 27.7743 12.1633 27.7743 8.03979C27.7743 3.91633 31.1984 0.561317 35.4071 0.561317C37.4839 0.561317 39.362 1.38521 40.7388 2.70885L39.3951 4.05236Z" />
                                                <path d="M52.6666 7.91318L57.6453 0.879978H59.8262V15.1995H57.8408V3.90107L52.6666 11.3855L47.492 3.90107V15.1995H45.5068V0.879978H47.6878L52.6666 7.91318Z" />
                                                <path d="M4.5399 0.559586C7.0473 0.559586 9.07995 2.52526 9.07995 4.94999C9.07995 6.0115 8.67185 7.03231 7.94025 7.80124L2.64392 13.3682H9.07995V15.1993H0V13.3682L6.43603 6.60338C6.86032 6.15747 7.09681 5.56558 7.09681 4.94999C7.09681 3.53662 5.95214 2.39083 4.5399 2.39083C3.12781 2.39083 1.98298 3.53662 1.98298 4.94999H0C0 2.52526 2.03249 0.559586 4.5399 0.559586Z" />
                                            </svg>
                                        </div>
                                        <div class="frame-content-area">
                                            <div class="content-block light"></div>
                                            <div class="content-block light"></div>
                                        </div>
                                        <div class="frame-button accent"></div>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <div class="card-label">forground Ï§ëÏã¨</div>
                                    <div class="card-sub-label">white bg</div>
                                </div>
                            </div>
                            
                            <!-- Mode 4: forground Ï§ëÏã¨ black bg -->
                            <div class="mode-card" data-mode="accent-on-bg-black">
                                <div class="card-checkbox">
                                    <svg class="checkbox-icon selected-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" style="display: none;">
                                        <path d="M4.0332 10.0227L8.69951 15.0004L15.9589 5.03613" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    <svg class="checkbox-icon unselected-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="10" cy="10" r="8" stroke="#ddd" stroke-width="2" fill="none"/>
                                    </svg>
                                </div>
                                <div class="card-preview">
                                    <div class="preview-frame black-bg">
                                        <div class="frame-header">
                                            <svg width="40" height="11" viewBox="0 0 60 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path fill-rule="evenodd" clip-rule="evenodd" d="M18.3088 0.55957C15.5807 0.55957 13.3688 2.70342 13.3688 5.34814C13.3688 7.92637 15.5253 10.0165 18.1852 10.0165C18.2997 10.0165 18.4097 10.0021 18.5197 9.98764C18.5724 9.98073 18.6251 9.97381 18.6783 9.96847L14.9751 15.1993H17.4012L22.4563 7.88935C22.973 7.14237 23.2492 6.25583 23.2492 5.34814C23.2492 2.70342 21.0375 0.55957 18.3088 0.55957ZM18.3088 8.30514C16.6757 8.30514 15.3518 6.98118 15.3518 5.34814C15.3518 3.71478 16.6757 2.39081 18.3088 2.39081C19.9418 2.39081 21.2658 3.71478 21.2658 5.34814C21.2658 6.98118 19.9418 8.30514 18.3088 8.30514Z" />
                                                <path d="M39.3951 4.05236C38.3724 3.02899 36.9648 2.39064 35.4071 2.39064C32.2922 2.39064 29.7579 4.92496 29.7579 8.03979C29.7579 11.1546 32.2922 13.6888 35.4071 13.6888C36.9648 13.6888 38.3724 13.0506 39.3951 12.0271L40.7388 13.3707C39.362 14.6942 37.4839 15.5183 35.4071 15.5183C31.1984 15.5183 27.7743 12.1633 27.7743 8.03979C27.7743 3.91633 31.1984 0.561317 35.4071 0.561317C37.4839 0.561317 39.362 1.38521 40.7388 2.70885L39.3951 4.05236Z" />
                                                <path d="M52.6666 7.91318L57.6453 0.879978H59.8262V15.1995H57.8408V3.90107L52.6666 11.3855L47.492 3.90107V15.1995H45.5068V0.879978H47.6878L52.6666 7.91318Z" />
                                                <path d="M4.5399 0.559586C7.0473 0.559586 9.07995 2.52526 9.07995 4.94999C9.07995 6.0115 8.67185 7.03231 7.94025 7.80124L2.64392 13.3682H9.07995V15.1993H0V13.3682L6.43603 6.60338C6.86032 6.15747 7.09681 5.56558 7.09681 4.94999C7.09681 3.53662 5.95214 2.39083 4.5399 2.39083C3.12781 2.39083 1.98298 3.53662 1.98298 4.94999H0C0 2.52526 2.03249 0.559586 4.5399 0.559586Z" />
                                            </svg>
                                        </div>
                                        <div class="frame-content-area">
                                            <div class="content-block white"></div>
                                            <div class="content-block white"></div>
                                        </div>
                                        <div class="frame-button accent"></div>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <div class="card-label">forground Ï§ëÏã¨</div>
                                    <div class="card-sub-label">black bg</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Mapping Ï†ïÎ≥¥Î≥¥Í∏∞ Ïª®Ìä∏Î°§ -->
                <div class="mapping-info-controls" style="margin: 20px 0; padding: 16px; border: 1px solid #e0e0e0; border-radius: 8px; background: #f8f9fa;">
                    <h3 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600;">Mapping Ï†ïÎ≥¥</h3>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <button 
                            id="showMappingBtn" 
                            onclick="showMappingInfo()" 
                            style="padding: 8px 16px; background: #007ACC; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">
                            ÏÑ†ÌÉùÎêú FrameÏùò Mapping Ï†ïÎ≥¥Î≥¥Í∏∞
                        </button>
                        <span id="mappingStatus" style="font-size: 12px; color: #666; margin-left: 8px;">FrameÏùÑ ÏÑ†ÌÉùÌïòÍ≥† Î≤ÑÌäºÏùÑ ÎàåÎü¨Ï£ºÏÑ∏Ïöî</span>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 8px;">
                        üí° ÏÑ†ÌÉùÎêú Frame Ïò§Î•∏Ï™ΩÏóê semantic‚Üíscale ÌÜ†ÌÅ∞ Îß§Ìïë Ï†ïÎ≥¥Í∞Ä ÌëúÏãúÎê©ÎãàÎã§
                    </div>
                </div>
                
                <div class="step-actions">
                    <button class="action-btn btn-secondary" onclick="goToStep(1)">Ïù¥Ï†Ñ</button>
                    <button class="action-btn btn-primary" onclick="applyCustomTheme()">custom theme Ï†ÅÏö©ÌïòÍ∏∞</button>
                </div>
            </div>
        </div>

        <!-- Scale Generator ÌÉ≠ Î∂ÄÎ∂Ñ ÏàòÏ†ï -->
        <div id="generatorContent" class="tab-content">
            <div class="section">
                <div class="section-title">Base Color Input</div>
                <div class="color-input-group">
                    <input type="color" id="baseColor" class="color-picker" value="#667eea">
                    <input type="text" id="hexInput" class="hex-input" value="#667EEA">
                </div>
            </div>

            <!-- Base Color Input ÏÑπÏÖò Îã§ÏùåÏóê Ï∂îÍ∞Ä -->
            <div class="section">
                <div class="section-title">Fine Tuning</div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="display: flex; gap: 8px;">
                        <label style="font-size: 11px;">Auto Mode</label>
                        <input type="checkbox" id="autoTuning">
                    </div>
                    <span id="tuningStatus" style="font-size: 10px; color: #666;">Manual: 0</span>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="range" id="tuningSlider" min="-10" max="10" value="0" style="flex: 1;">
                    <span id="tuningValue" style="min-width: 30px; text-align: center;">0</span>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Background Mode</div>
                <div class="mode-buttons">
                    <button class="mode-btn active" onclick="setMode('light')">Light Mode</button>
                    <button class="mode-btn" onclick="setMode('dark')">Dark Mode</button>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Variable Name</div>
                <input type="text" id="variableName" class="hex-input" placeholder="Ïòà: primary, brand, blue" style="width: 100%;">
                <p style="font-size: 9px; color: #666; margin-top: 4px;">
                    Î≥ÄÏàò Ïù¥Î¶Ñ ÌòïÏãù: {name}-50, {name}-100, {name}-200...
                </p>
            </div>

            <div class="section">
                <div class="section-title">Generated Color Palette</div>
                <div class="color-grid" id="colorResults">
                    <!-- ÏÉâÏÉÅÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                </div>
            </div>

            <!-- Ïï°ÏÖò Î≤ÑÌäºÎì§ Ï∂îÍ∞Ä -->
            <div class="action-buttons" style="display: flex; flex-direction: column; gap: 2px; margin-top: 4px;">
                <button class="action-btn btn-primary" onclick="createVariables()">
                    Create Variables (ÌòÑÏû¨ Î™®Îìú)
                </button>
                <button class="action-btn btn-success" onclick="createDualModeVariables()">
                    Create Light + Dark Variables
                </button>
                <button class="action-btn btn-secondary" onclick="createStyles()">
                    Create Color Styles
                </button>
            </div>
        </div>

        <!-- Tone Matching ÌÉ≠ -->
        <div id="toneMatchingContent" class="tab-content">
            <div class="header">
                <div class="section-title"> Ïñ¥Ïö∏Î¶¨Îäî ÏÉâÏÉÅÏùÑ Ï∂îÏ≤úÌï¥Ïöî.</div>
            </div>

            <!-- Í∏∞Ï§Ä ÏÉâÏÉÅ ÏÑ§Ï†ï -->
            <div class="section">
                <div class="section-title">Step 1. Í∏∞Ï§Ä ÏÉâÏÉÅ Ï†ïÌïòÍ∏∞</div>
                <p style="color: #666; margin-bottom: 8px; font-size: 10px;">Í∏∞Ï§ÄÏù¥ Îê† ÏÉâÏÉÅÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
                
                <div class="color-input-group">
                    <input type="color" id="referenceColorPicker" class="color-picker" value="#667eea">
                    <input type="text" id="referenceColorHex" class="hex-input" value="#667EEA">
                </div>
                
                <div style="display: flex; gap: 6px; margin-top: 8px;">
                    <button id="setRefBtn" class="action-btn btn-primary" style="flex: 2;">Set Reference</button>
                    <button id="clearRefBtn" class="action-btn btn-secondary" style="flex: 1; min-width: 60px;">Clear</button>
                </div>
                
                <div id="referenceStatus" style="color: #666; font-size: 10px; margin-top: 4px;">ÌòÑÏû¨ ÏÑ§Ï†ïÎêú Í∏∞Ï§Ä Ïª¨Îü¨Í∞Ä ÏóÜÏäµÎãàÎã§.</div>
                <div id="referenceDisplay"></div>
            </div>
            
            <!-- ÏÉà ÏÉâÏÉÅ ÏûÖÎ†• -->
            <div class="section">
                <div class="section-title">Step 2. ÏÉàÎ°úÏö¥ Ïª¨Îü¨ ÏûÖÎ†•ÌïòÍ∏∞</div>
                <p style="color: #666; margin-bottom: 8px; font-size: 10px;">ÏõêÌïòÎäî ÏÉâÏÉÅÏùÑ ÏûÖÎ†•ÌïòÎ©¥ ÌÜ§ Îß§Ïπ≠Ïù¥ Ï†úÍ≥µÎê©ÎãàÎã§</p>
                
                <div class="tone-input-area">
                    <div class="color-input-group">
                        <input type="color" id="newColorPicker" class="color-picker" value="#ff0000">
                        <input type="text" id="newColorHex" class="hex-input" value="#FF0000">
                    </div>
                    <button id="getSuggestionsBtn" class="action-btn btn-success">Ï∂îÏ≤úÎ∞õÍ∏∞</button>
                    <p style="font-size: 10px; color: #666; margin-top: 4px;">Ïù¥ ÏÉâÏÉÅÏùÄ Í∏∞Ï§Ä ÌÜ§Ïóê ÎßûÍ≤å Ï°∞Ï†ïÎê©ÎãàÎã§.</p>
                </div>
                
                <div id="toneMatchingResults"></div>
            </div>
        </div>

        <!-- ÏÑ±Í≥µ Î©îÏãúÏßÄ -->
        <div class="success-message" id="successMessage"></div>
    </div>

    <script>
        
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let currentMode = 'light';
        let generatedColors = [];
        let referenceColor = null;
        let currentTheme = null;

        // ÏÉâÏÉÅ Ïú†Ìã∏Î¶¨Ìã∞
        class ColorUtils {
            static hexToRgb(hex) {
                var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : { r: 0, g: 0, b: 0 };
            }

            static rgbToHex(r, g, b) {
                return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
            }

            static hexToHsl(hex) {
                var rgb = this.hexToRgb(hex);
                return this.rgbToHsl(rgb.r / 255, rgb.g / 255, rgb.b / 255);
            }

            static rgbToHsl(r, g, b) {
                var max = Math.max(r, g, b);
                var min = Math.min(r, g, b);
                let h, s, l = (max + min) / 2;

                if (max === min) {
                    h = s = 0;
                } else {
                    var d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                    switch (max) {
                        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                        case g: h = (b - r) / d + 2; break;
                        case b: h = (r - g) / d + 4; break;
                    }
                    h /= 6;
                }

                return [h * 360, s * 100, l * 100];
            }

            static hslToRgb(h, s, l) {
                h /= 360; s /= 100; l /= 100;
                var a = s * Math.min(l, 1 - l);
                var f = n => {
                    var k = (n + h * 12) % 12;
                    return l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
                };
                return [
                    Math.round(f(0) * 255),
                    Math.round(f(8) * 255),
                    Math.round(f(4) * 255)
                ];
            }

            static hslToHex(h, s, l) {
                var [r, g, b] = this.hslToRgb(h, s, l);
                return this.rgbToHex(r, g, b);
            }

            // === Contrast <-> Luminance ÎèÑÏö∞ÎØ∏ (white/dark Î∞∞Í≤Ω) ===
            static luminanceFromContrastVsWhite(contrast) {
                // contrast = (1.0 + 0.05) / (Y + 0.05)  ‚Üí  Y = (1.05 / C) - 0.05
                return (1.05 / contrast) - 0.05;
            }

            static luminanceFromContrastVsBlack(contrast) {
                // contrast = (Y + 0.05) / 0.05  ‚Üí  Y = 0.05 * contrast - 0.05
                return 0.05 * contrast - 0.05;
            }

            static luminanceFromContrastVsDarkBg(contrast) {
                // #0c0c0cÏùò luminance Í≥ÑÏÇ∞
                const darkBgLuminance = this.getLuminance(12, 12, 12);
                // contrast = (Y + 0.05) / (darkBgLuminance + 0.05)  ‚Üí  Y = contrast * (darkBgLuminance + 0.05) - 0.05
                return contrast * (darkBgLuminance + 0.05) - 0.05;
            }

            // HSL(h,s,L)ÏóêÏÑú LÏùÑ Ïù¥ÏßÑÌÉêÏÉâÌï¥ÏÑú Î™©Ìëú YÏóê ÏµúÎåÄÍ∑ºÏ†ë
            static solveLForY(h, s, targetY) {
                let lo = 0, hi = 100, bestL = 50, bestErr = 1e9;
                for (let i = 0; i < 24; i++) {
                    const mid = (lo + hi) / 2;
                    const [r, g, b] = this.hslToRgb(h, s, mid);
                    const Y = this.getLuminance(r, g, b);
                    const err = Math.abs(Y - targetY);
                    if (err < bestErr) { bestErr = err; bestL = mid; }
                    // white Í∏∞Ï§Ä: YÍ∞Ä ÎÜíÏúºÎ©¥ Îçî Ïñ¥Îë°Í≤å(hi ÎÇ¥Î¶º)
                    if (Y > targetY) hi = mid; else lo = mid;
                }
                return { L: bestL, err: bestErr };
            }

            // (Í∞ÄÎä•ÌïòÎ©¥ Ï±ÑÎèÑ Î≥¥Ï°¥) Î™©Ìëú ÎåÄÎπÑÎ•º ÎßåÏ°±ÌïòÎäî HSL Ï∞æÍ∏∞
            static solveHSLForContrast(h, sInput, contrastTarget, background = 'light') {
                const bgRgb = background === 'light' 
                    ? { r: 255, g: 255, b: 255 }
                    : { r: 12, g: 12, b: 12 };

                // Ï±ÑÎèÑÎäî ÏûÖÎ†•Í∞í Ïö∞ÏÑ†, Î∂àÍ∞ÄÏãú Í∑πÏÜåÌè≠ Î≥¥Ï†ï
                const SAT_CAND = [1.0, 0.95, 0.9, 0.85].map(f => Math.max(5, Math.min(100, sInput * f)));
                let best = null;

                for (const s of SAT_CAND) {
                    // LÍ∞íÏùÑ Ïù¥ÏßÑÌÉêÏÉâÏúºÎ°ú Î™©Ìëú ÎåÄÎπÑÏóê ÎßûÏ∂§
                    let lo = 0, hi = 100, bestL = 50, bestErr = 1e9;
                    
                    for (let i = 0; i < 24; i++) {
                        const mid = (lo + hi) / 2;
                        const [r, g, b] = this.hslToRgb(h, s, mid);
                        const actualContrast = this.getContrast({ r, g, b }, bgRgb);
                        const err = Math.abs(actualContrast - contrastTarget);
                        
                        if (err < bestErr) { 
                            bestErr = err; 
                            bestL = mid; 
                        }
                        
                        if (actualContrast > contrastTarget) {
                            if (background === 'light') {
                                lo = mid; // Light: ÎåÄÎπÑÍ∞Ä ÎÜíÏúºÎ©¥ LÏùÑ ÎÜíÏó¨ÏÑú ÎåÄÎπÑÎ•º Ï§ÑÏûÑ (Î∞ùÍ≤å)
                            } else {
                                hi = mid; // Dark: ÎåÄÎπÑÍ∞Ä ÎÜíÏúºÎ©¥ LÏùÑ ÎÇÆÏ∂∞ÏÑú ÎåÄÎπÑÎ•º Ï§ÑÏûÑ (Ïñ¥Îë°Í≤å)
                            }
                        } else {
                            if (background === 'light') {
                                hi = mid; // Light: ÎåÄÎπÑÍ∞Ä ÎÇÆÏúºÎ©¥ LÏùÑ ÎÇÆÏ∂∞ÏÑú ÎåÄÎπÑÎ•º ÎÜíÏûÑ (Ïñ¥Îë°Í≤å)
                            } else {
                                lo = mid; // Dark: ÎåÄÎπÑÍ∞Ä ÎÇÆÏúºÎ©¥ LÏùÑ ÎÜíÏó¨ÏÑú ÎåÄÎπÑÎ•º ÎÜíÏûÑ (Î∞ùÍ≤å)
                            }
                        }
                    }
                    
                    if (!best || bestErr < best.err) {
                        best = { h, s, l: bestL, err: bestErr };
                    }
                    if (bestErr < 0.01) break; // Ï∂©Î∂ÑÌûà Í∑ºÏ†ëÌïòÎ©¥ Ï°∞Í∏∞ Ï¢ÖÎ£å
                }
                return best; // {h,s,l,err}
            }

            static getLuminance(r, g, b) {
                var [rs, gs, bs] = [r, g, b].map(c => {
                    c = c / 255;
                    return c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
                });
                return 0.2126 * rs + 0.7152 * gs + 0.0722 * bs;
            }

            static getContrast(rgb1, rgb2) {
                var l1 = this.getLuminance(rgb1.r, rgb1.g, rgb1.b);
                var l2 = this.getLuminance(rgb2.r, rgb2.g, rgb2.b);
                var lighter = Math.max(l1, l2);
                var darker = Math.min(l1, l2);
                return (lighter + 0.05) / (darker + 0.05);
            }

            // Í∞ÄÏû• Í∞ÄÍπåÏö¥ Ïä§ÌÖù Ï∞æÍ∏∞
            static findClosestStep(hex, mode) {
                mode = mode || 'light';  // Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
                var [h, s, l] = this.hexToHsl(hex);
                var steps = [50, 75, 100, 150, 200, 300, 400, 500, 600, 700, 800, 900, 950];
                let closestStep = 500;
                let minDiff = Infinity;
                
                steps.forEach(function(step) {
                    let targetLightness;
                    if (mode === 'light') {
                        // ColorGeneratorÏôÄ ÎèôÏùºÌïú Î°úÏßÅ ÏÇ¨Ïö©
                        switch(step) {
                            case 50:  targetLightness = 95; break;
                            case 75:  targetLightness = 90; break;
                            case 100: targetLightness = 85; break;
                            case 150: targetLightness = 78; break;
                            case 200: targetLightness = 70; break;
                            case 300: targetLightness = 60; break;
                            case 400: targetLightness = 50; break;
                            case 500: targetLightness = 40; break;
                            case 600: targetLightness = 32; break;
                            case 700: targetLightness = 25; break;
                            case 800: targetLightness = 18; break;
                            case 900: targetLightness = 12; break;
                            case 950: targetLightness = 8; break;
                            default: targetLightness = 50;
                        }
                    } else {
                        // Dark mode Î™ÖÎèÑ Îß§Ìïë
                        switch(step) {
                            case 50:  targetLightness = 5; break;
                            case 75:  targetLightness = 10; break;
                            case 100: targetLightness = 15; break;
                            case 150: targetLightness = 22; break;
                            case 200: targetLightness = 30; break;
                            case 300: targetLightness = 40; break;
                            case 400: targetLightness = 50; break;
                            case 500: targetLightness = 60; break;
                            case 600: targetLightness = 68; break;
                            case 700: targetLightness = 75; break;
                            case 800: targetLightness = 82; break;
                            case 900: targetLightness = 88; break;
                            case 950: targetLightness = 92; break;
                            default: targetLightness = 50;
                        }
                    }
                    
                    var diff = Math.abs(l - targetLightness);
                    if (diff < minDiff) {
                        minDiff = diff;
                        closestStep = step;
                    }
                });
                
                return closestStep;
            }
        }

        // ÏÉâÏÉÅ ÏÉùÏÑ±Í∏∞
        class ColorGenerator {
    constructor() {
        this.steps = [50, 75, 100, 150, 200, 300, 400, 500, 600, 700, 800, 900, 950];
        
        // Light Mode ÌöåÏÉâ ÌÜ§ (Í∏∞Ï°¥ Í∑úÏπôÎåÄÎ°ú)
        this.lightModeGrayTones = [
            '#FFFFFF', // 50
            '#F7F7F7', // 75
            '#F0F0F0', // 100
            '#E8E8E8', // 150
            '#DDDDDD', // 200
            '#CCCCCC', // 300
            '#B4B4B4', // 400
            '#9E9E9E', // 500
            '#8A8A8A', // 600
            '#6A6A6A', // 700
            '#464646', // 800
            '#1F1F1F', // 900
            '#000000'  // 950
        ];
        
        // Dark Mode ÌöåÏÉâ ÌÜ§
        this.darkModeGrayTones = [
            '#0C0C0C', // 50
            '#141414', // 75
            '#1C1C1C', // 100
            '#242424', // 150
            '#313131', // 200
            '#414141', // 300
            '#525252', // 400
            '#626262', // 500
            '#808080', // 600
            '#ADADAD', // 700
            '#E3E3E3', // 800
            '#F4F4F4', // 900
            '#FCFCFC'  // 950
        ];

        // Dark Mode ÎåÄÎπÑÍ∞í (#0c0c0c Î∞∞Í≤Ω Í∏∞Ï§Ä)
        this.darkModeContrastRatios = [
            1.00, // 50
            1.06, // 75
            1.15, // 100
            1.26, // 150
            1.50, // 200
            1.92, // 300
            2.50, // 400
            3.21, // 500
            4.95, // 600
            8.72, // 700
            15.24, // 800
            17.79, // 900
            20.0   // 950
        ];
    }

    getAutoTuningValue(hex) {
        var [h, s, l] = ColorUtils.hexToHsl(hex);
        let tuning = 0;
        
        // ÏÉâÏÉÅÎ≥Ñ Ï°∞Ï†ï
        if (h >= 45 && h <= 75) tuning = -3;      // ÎÖ∏ÎûÄÏÉâ: Îçî Ïñ¥Îë°Í≤å
        else if (h >= 15 && h <= 45) tuning = -2; // Ï£ºÌô©ÏÉâ
        else if (h >= 210 && h <= 270) tuning = 2; // ÌååÎûÄÏÉâ: Îçî Î∞ùÍ≤å
        else if (h >= 180 && h <= 210) tuning = 1; // Ï≤≠Î°ùÏÉâ
        
        // Ï±ÑÎèÑÏóê Îî∞Î•∏ Ï∂îÍ∞Ä Ï°∞Ï†ï
        if (s > 80) tuning -= 1;
        else if (s < 30) tuning += 1;
        
        return Math.max(-10, Math.min(10, tuning));
    }

    generateColors(inputHex, mode, tuningValue = 0) {
        const [hInput, sInput, lInput] = ColorUtils.hexToHsl(inputHex);
        const backgroundRgb = (mode === 'light') ? { r: 255, g: 255, b: 255 } : { r: 12, g: 12, b: 12 };

        // Î¨¥Ï±ÑÏÉâÏùÄ Í∏∞Ï°¥ ÌöåÏÉâ ÌÜ§ Í∑∏ÎåÄÎ°ú (UI ÏùòÎèÑ Ïú†ÏßÄ)
        if (sInput < 5) {
            const toneSet = (mode === 'light') ? this.lightModeGrayTones : this.darkModeGrayTones;
            return this.steps.map((step, i) => {
                const hex = toneSet[i];
                const rgb = ColorUtils.hexToRgb(hex);
                const contrast = ColorUtils.getContrast(rgb, backgroundRgb);
                return { step, hex, contrast, isClosest: false };
            });
        }

        // 1) grayscale Î∂ÑÌè¨Î•º Í∏∞Î∞òÏúºÎ°ú ÌòÑÏû¨ Î™®ÎìúÏùò "Î™©Ìëú ÎåÄÎπÑ" ÏÇ∞Ï∂ú
        const targets = this.buildTargetContrasts(mode, hInput);

        // 2) Í∞Å Ïä§ÌÖùÏóêÏÑú Î™©Ìëú ÎåÄÎπÑÎ•º ÎßåÏ°±ÌïòÎèÑÎ°ù HSL Í≥ÑÏÇ∞ (hue Í≥†Ï†ï, Ï±ÑÎèÑ Î≥¥Ï°¥)
        const colors = this.steps.map((step, i) => {
            const targetContrast = targets[i];
            const solved = ColorUtils.solveHSLForContrast(hInput, sInput, targetContrast, mode);

            // ÌäúÎãù: ÏµúÏ¢Ö LÏóê ÏÜåÌè≠ Í∞ÄÍ∞ê
            let L = Math.max(0, Math.min(100, solved.l + (tuningValue || 0)));
            const [r, g, b] = ColorUtils.hslToRgb(solved.h, solved.s, L);
            const hex = ColorUtils.rgbToHex(r, g, b);
            const contrast = ColorUtils.getContrast({ r, g, b }, backgroundRgb);

            return { step, hex, contrast, isClosest: false };
        });

        // 3) ÏûÖÎ†•ÏÉâÍ≥º Í∞ÄÏû• Í∞ÄÍπåÏö¥ L(ÎòêÎäî ÌïÑÏöîÏãú ŒîE)Î°ú ‚òÖ ÌëúÏãú
        let best = { i: 0, d: 1e9 };
        colors.forEach((c, i) => {
            const L = ColorUtils.hexToHsl(c.hex)[2];
            const d = Math.abs(L - lInput);
            if (d < best.d) best = { i, d };
        });
        colors[best.i].isClosest = true;

        return colors;
    }

    // Î™©Ìëú ÎåÄÎπÑ ÎπåÎçî - Í∞Å Ïä§ÌÖùÏùò Î™©Ìëú ÎåÄÎπÑÎπÑÏú® Í≥ÑÏÇ∞
    buildTargetContrasts(mode, inputHue) {
        const steps = this.steps;
        const bg = (mode === 'light') ? { r: 255, g: 255, b: 255 } : { r: 12, g: 12, b: 12 };

        // 1) Grayscale ÎåÄÎπÑÏú® Î∂ÑÌè¨ Í≥ÑÏÇ∞
        const grayContrast = (mode === 'light') ? 
            steps.map((_, i) => {
                const hex = this.lightModeGrayTones[i];
                const rgb = ColorUtils.hexToRgb(hex);
                return ColorUtils.getContrast(rgb, { r: 255, g: 255, b: 255 });
            }) :
            this.darkModeContrastRatios;

        // 2) ÏûÖÎ†• hueÏùò anchor ÎåÄÎπÑ Í≥ÑÏÇ∞ (Step50/Step950)
        let hueMinContrast, hueMaxContrast;
        
        if (mode === 'light') {
            // Light: Step50=1.03 Í≥†Ï†ï, Step950=20.0 Í≥†Ï†ï
            hueMinContrast = 1.03; // Step50 anchor
            hueMaxContrast = 20.0; // Step950 anchor
        } else {
            // Dark: Step50=Í∞ÄÏû•Ïñ¥Îë†(L=0), Step950=ÏµúÎåÄ 19.0ÏúºÎ°ú Ï†úÌïú (ÏôÑÏ†Ñ Ìù∞ÏÉâ Î∞©ÏßÄ)
            const darkestRgb = ColorUtils.hexToRgb(ColorUtils.hslToHex(inputHue, 100, 0));
            const brightestRgb = ColorUtils.hexToRgb(ColorUtils.hslToHex(inputHue, 100, 100));
            hueMinContrast = ColorUtils.getContrast(darkestRgb, bg);   // Step50 anchor
            const theoreticalMax = ColorUtils.getContrast(brightestRgb, bg);
            hueMaxContrast = Math.min(19.0, theoreticalMax); // Step950ÏùÑ 19.0ÏúºÎ°ú Ï†úÌïú
        }

        // 3) Grayscale Î∂ÑÌè¨Ïùò ÎπÑÏú®Î°ú hue Î≤îÏúÑÏóê Î≥¥Í∞Ñ
        const grayMinContrast = grayContrast[0];
        const grayMaxContrast = grayContrast[grayContrast.length - 1];
        
        return grayContrast.map(grayC => {
            const ratio = (grayC - grayMinContrast) / (grayMaxContrast - grayMinContrast);
            return hueMinContrast + ratio * (hueMaxContrast - hueMinContrast);
        });
    }
}

        // Wizard Í¥ÄÎ†® Ìï®ÏàòÎì§
        let currentWizardStep = 1;
        let wizardThemeData = null;

        function goToStep(stepNumber) {
            
            // ÌòÑÏû¨ Ïä§ÌÖùÏóêÏÑú Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Î∞è Ï≤òÎ¶¨
            if (stepNumber === 3 && currentWizardStep === 1) {
                // Step 1ÏóêÏÑú Step 3Î°ú: ÌÖåÎßà Î≥ÄÏàòÎ•º Î®ºÏ†Ä ÏÉùÏÑ±ÌïòÍ≥† ÌÖåÎßà Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
                createCustomThemeVariablesAndProceed();
                return; // ÎπÑÎèôÍ∏∞ Ï≤òÎ¶¨Î•º ÏúÑÌï¥ Ïó¨Í∏∞ÏÑú Î¶¨ÌÑ¥
            }

            // ÌîÑÎ°úÍ∑∏Î†àÏä§ ÏóÖÎç∞Ïù¥Ìä∏
            updateProgressBar(stepNumber);

            // Ïä§ÌÖù ÏΩòÌÖêÏ∏† ÏóÖÎç∞Ïù¥Ìä∏
            updateStepContent(stepNumber);

            currentWizardStep = stepNumber;
        }
        
        function updateProgressBar(stepNumber) {
            document.querySelectorAll('.progress-segment').forEach(segment => {
                const step = parseInt(segment.dataset.step);
                segment.classList.remove('active', 'completed');
                
                if (step < stepNumber) {
                    segment.classList.add('completed');
                } else if (step === stepNumber) {
                    segment.classList.add('active');
                }
            });
        }
        
        function updateStepContent(stepNumber) {
            document.querySelectorAll('.wizard-step').forEach(step => {
                step.classList.remove('active');
            });
            
            const targetStep = document.getElementById('wizardStep' + stepNumber);
            if (targetStep) {
                targetStep.classList.add('active');
                
                // Step 3ÏóêÏÑú Î™®Îìú ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
                if (stepNumber === 3) {
                    setTimeout(() => {
                        const baseColorInput = document.getElementById('wizardThemeBaseHex');
                        if (baseColorInput && baseColorInput.value) {
                            updateAllModePreviewsWithColor(baseColorInput.value);
                        }
                    }, 100);
                }
            } else {
                console.error('Step element not found:', 'wizardStep' + stepNumber);
            }
        }
        
        function createCustomThemeVariablesAndProceed() {
            const themeName = document.getElementById('wizardThemeNameInput').value;
            const baseColor = document.getElementById('wizardThemeBaseHex').value;
            
            if (!themeName || !baseColor) {
                showMessage('ÌÖåÎßà Ïù¥Î¶ÑÍ≥º ÏÉâÏÉÅÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            // ÌÖåÎßà ÏÉùÏÑ±
            const tuningValue = 0; // Í∏∞Î≥∏Í∞í
            currentTheme = themeGenerator.generateTheme(baseColor, themeName, 'accent-on-bg-off', tuningValue);
            
            // Î™®Îìú Ïπ¥Îìú ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
            updateModeCardPreviews();
            
            // Î∞±ÏóîÎìúÏóê ÌÖåÎßà Î≥ÄÏàò ÏÉùÏÑ± ÏöîÏ≤≠
            parent.postMessage({
                pluginMessage: {
                    type: 'create-custom-theme',
                    theme: currentTheme
                }
            }, '*');
            
            showMessage('ÌÖåÎßà Î≥ÄÏàò ÏÉùÏÑ± Ï§ë...');
            
            // Ïû†Ïãú ÌõÑ Step 3Î°ú Î∞îÎ°ú ÏßÑÌñâ
            setTimeout(() => {
                generateWizardTheme(); // ÌÜ†ÌÅ∞ ÎØ∏Î¶¨Î≥¥Í∏∞ ÏÉùÏÑ±
                updateProgressBar(3);
                updateStepContent(3);
                currentWizardStep = 3;
                showMessage('ÌÖåÎßà Î≥ÄÏàòÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!');
            }, 1000);
        }

        function generateWizardTheme() {
            
            // currentThemeÍ∞Ä Ïù¥ÎØ∏ ÏÉùÏÑ±ÎêòÏñ¥ ÏûàÎã§Î©¥ Í∑∏Í≤ÉÏùÑ ÏÇ¨Ïö©
            if (currentTheme) {
                const themeName = currentTheme.themeName;
                const closestStep = currentTheme.selectedStep || 200;
                
                // Step 2Í∞Ä Ï†úÍ±∞ÎêòÏóàÏúºÎØÄÎ°ú ÌÜ†ÌÅ∞ ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏ ÏÉùÎûµ

                // wizardThemeDataÏôÄ ÎèôÍ∏∞Ìôî
                wizardThemeData = {
                    themeName: themeName,
                    baseColor: currentTheme.baseColor,
                    closestStep: closestStep,
                    applicationMode: currentTheme.applicationMode || 'accent-on-bg-off'
                };
            } else {
                // Í∏∞Ï°¥ Î°úÏßÅ (fallback)
                const themeName = document.getElementById('wizardThemeNameInput').value;
                const baseColor = document.getElementById('wizardThemeBaseHex').value;
                
                // Scale GeneratorÏôÄ ÎèôÏùºÌïú Î°úÏßÅ ÏÇ¨Ïö©
                const closestStep = ColorUtils.findClosestStep(baseColor, 'light');
                

                wizardThemeData = {
                    themeName: themeName,
                    baseColor: baseColor,
                    closestStep: closestStep,
                    applicationMode: 'accent-on-bg-off'
                };
            }
            
        }

        function selectModeCard(card, mode) {
            
            // Î™®Îì† Ïπ¥ÎìúÏóêÏÑú selected ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
            document.querySelectorAll('.mode-card').forEach(c => {
                c.classList.remove('selected');
            });
            
            // ÌÅ¥Î¶≠Îêú Ïπ¥ÎìúÏóê selected ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
            card.classList.add('selected');
            
            // ÌÖåÎßà Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
            if (wizardThemeData) {
                wizardThemeData.applicationMode = mode;
            }
        }

        // Î™®ÎìúÎ≥Ñ ÌÜ†ÌÅ∞ ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
        function updateModeCardPreviews() {
            if (!currentTheme) return;
            
            
            const modes = ['accent-on-bg-off', 'accent-off-bg-on', 'accent-on-bg-fixed', 'accent-on-bg-black'];
            
            modes.forEach(mode => {
                const tokens = getTokensForMode(mode);
                updateModeCardPreview(mode, tokens);
            });
        }
        
        // ÌäπÏ†ï Î™®ÎìúÏùò ÌÜ†ÌÅ∞Í∞í Í≥ÑÏÇ∞ (Î∞ùÍ∏∞ Í∏∞Ï§ÄÏóê Îî∞Î•∏ Îß§Ìïë Í∑úÏπô Ï†ÅÏö©)
        function getTokensForMode(mode) {
            if (!currentTheme || !currentTheme.scaleColors) return null;
            
            const lightColors = currentTheme.scaleColors.light;
            const darkColors = currentTheme.scaleColors.dark;
            const selectedStep = currentTheme.selectedStep || 500;
            
            // Î∞ùÍ∏∞ Í∏∞Ï§Ä (Î∞±ÏóîÎìú getDynamicMappingsÏôÄ ÎèôÏùºÌïú Î°úÏßÅ)
            let isBrightColor = selectedStep < 200; // 200 ÎØ∏Îßå
            if (currentTheme.baseColor) {
                const hsl = ColorUtils.hexToHsl(currentTheme.baseColor);
                const lightness = hsl[2];
                // Î∞ùÍ∏∞Í∞Ä 80% Ïù¥ÏÉÅÏù¥Î©¥ bright colorÎ°ú Î∂ÑÎ•ò
                if (lightness >= 80) {
                    isBrightColor = true;
                }
            }
            
            let backgroundLight, textPrimaryLight, fillPrimaryLight;
            
            switch(mode) {
                case 'accent-on-bg-off':
                    // forground Ï§ëÏã¨: Î∞∞Í≤Ω Í≥†Ï†ï, ÌÖçÏä§Ìä∏ÏôÄ fillÏù¥ accent
                    backgroundLight = '#FFFFFF';
                    if (isBrightColor) {
                        textPrimaryLight = lightColors.find(c => c.step === 900)?.hex || '#000000';
                        fillPrimaryLight = lightColors.find(c => c.step === 600)?.hex;
                    } else {
                        textPrimaryLight = lightColors.find(c => c.step === selectedStep)?.hex;
                        fillPrimaryLight = lightColors.find(c => c.step === selectedStep)?.hex;
                    }
                    break;
                    
                case 'accent-off-bg-on':
                    // background Ï§ëÏã¨: Î∞∞Í≤ΩÏù¥ accent, ÌÖçÏä§Ìä∏ÏôÄ fillÏùÄ contrasting
                    backgroundLight = lightColors.find(c => c.step === selectedStep)?.hex;
                    if (isBrightColor) {
                        textPrimaryLight = lightColors.find(c => c.step === 900)?.hex || '#000000';
                        fillPrimaryLight = lightColors.find(c => c.step === 800)?.hex;
                    } else {
                        textPrimaryLight = '#FFFFFF';
                        fillPrimaryLight = lightColors.find(c => c.step === 50)?.hex;
                    }
                    break;
                    
                case 'accent-on-bg-fixed':
                    // forground Ï§ëÏã¨, white bg Í≥†Ï†ï
                    backgroundLight = '#FFFFFF';
                    if (isBrightColor) {
                        textPrimaryLight = lightColors.find(c => c.step === 900)?.hex || '#000000';
                        fillPrimaryLight = lightColors.find(c => c.step === 600)?.hex;
                    } else {
                        textPrimaryLight = lightColors.find(c => c.step === selectedStep)?.hex;
                        fillPrimaryLight = lightColors.find(c => c.step === selectedStep)?.hex;
                    }
                    break;
                    
                case 'accent-on-bg-black':
                    // forground Ï§ëÏã¨, black bg Í≥†Ï†ï (Î∞±ÏóîÎìúÏôÄ ÎèôÏùºÌïú Î°úÏßÅ)
                    backgroundLight = '#1f1f1f';
                    // Ïã§Ï†ú GRAY:50 ÏÉâÏÉÅ ÏÇ¨Ïö© (Light Mode gray scaleÏùò 50Î≤àÏß∏)
                    const colorGenerator = new ColorGenerator();
                    textPrimaryLight = colorGenerator.lightModeGrayTones[0]; // 50Î≤àÏß∏ = index 0 = '#FFFFFF'
                    if (isBrightColor) {
                        fillPrimaryLight = lightColors.find(c => c.step === selectedStep)?.hex;
                    } else {
                        fillPrimaryLight = lightColors.find(c => c.step === selectedStep)?.hex;
                    }
                    break;
            }
            
            
            return {
                background: backgroundLight,
                textPrimary: textPrimaryLight,
                fillPrimary: fillPrimaryLight
            };
        }
        
        // Î™®Îìú Ïπ¥Îìú ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
        function updateModeCardPreview(mode, tokens) {
            if (!tokens) return;
            
            const card = document.querySelector(`[data-mode="${mode}"]`);
            if (!card) return;
            
            const previewFrame = card.querySelector('.preview-frame');
            const frameHeader = card.querySelector('.frame-header');
            const frameButton = card.querySelector('.frame-button');
            
            // Î™®Îì† Î™®ÎìúÏùò mode-card ÏûêÏ≤¥Ïóê Î∞∞Í≤ΩÏÉâ Ï†ÅÏö©
            card.style.backgroundColor = tokens.background;
            
            // ÌÖçÏä§Ìä∏ ÏÉâÏÉÅ Ï†ÅÏö© (Î°úÍ≥†)
            if (frameHeader) {
                const svgPaths = frameHeader.querySelectorAll('svg path');
                svgPaths.forEach(path => {
                    path.setAttribute('fill', tokens.textPrimary);
                    path.style.setProperty('fill', tokens.textPrimary, 'important');
                });
            }
            
            // Î≤ÑÌäº ÏÉâÏÉÅ Ï†ÅÏö©
            if (frameButton) {
                frameButton.style.backgroundColor = tokens.fillPrimary;
            }
            
            // Ïπ¥Îìú ÎùºÎ≤® ÌÖçÏä§Ìä∏ ÏÉâÏÉÅ Ï†ÅÏö©
            const cardLabel = card.querySelector('.card-label');
            const cardSubLabel = card.querySelector('.card-sub-label');
            if (cardLabel) {
                cardLabel.style.setProperty('color', tokens.textPrimary, 'important');
            }
            if (cardSubLabel) {
                cardSubLabel.style.setProperty('color', tokens.textPrimary, 'important');
            }
        }

        // ÌòÑÏû¨ ÏûÖÎ†•Îêú ÏÉâÏÉÅÏùÑ Í∏∞Î∞òÏúºÎ°ú Î™®Îì† Î™®Îìú Ïπ¥ÎìúÏùò ÎØ∏Î¶¨Î≥¥Í∏∞Î•º Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏ÌïòÎäî Ìï®Ïàò
        function updateAllModePreviewsWithColor(baseColor) {
            if (!baseColor || !baseColor.startsWith('#')) {
                return;
            }
            
            
            // Í∞Å Î™®ÎìúÏóê ÎåÄÌï¥ ÏÉâÏÉÅ ÌÜ†ÌÅ∞ Í≥ÑÏÇ∞ Î∞è ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
            const modes = ['accent-on-bg-off', 'accent-on-bg-fixed', 'accent-off-bg-on', 'accent-on-bg-black'];
            
            modes.forEach(mode => {
                const tokens = calculatePreviewTokensForMode(baseColor, mode);
                if (tokens) {
                    updateModeCardPreview(mode, tokens);
                }
            });
        }

        // Í∞Å Î™®ÎìúÎ≥ÑÎ°ú ÎØ∏Î¶¨Î≥¥Í∏∞Ïö© ÏÉâÏÉÅ ÌÜ†ÌÅ∞ÏùÑ Í≥ÑÏÇ∞ÌïòÎäî Ìï®Ïàò
        function calculatePreviewTokensForMode(baseColor, mode) {
            if (!baseColor) return null;
            
            // HSL Î≥ÄÌôò Ìï®ÏàòÎì§Ïù¥ ÏóÜÎã§Î©¥ Í∞ÑÎã®Ìïú Íµ¨ÌòÑ
            const hsl = ColorUtils.hexToHsl ? ColorUtils.hexToHsl(baseColor) : hexToHsl(baseColor);
            const lightness = hsl[2];
            const hue = hsl[0];
            
            // Î∞ùÏùÄ ÏÉâÏÉÅ ÌåêÎã®: 1) Î∞ùÍ∏∞ 80% Ïù¥ÏÉÅ ÎòêÎäî 2) BornBright ÏÉâÏÉÅ (Hue 40¬∞-190¬∞)
            const isLightColor = lightness >= 80 || (hue >= 40 && hue <= 190);
            
            let tokens = {
                background: '#ffffff',
                textPrimary: '#000000',
                fillPrimary: baseColor
            };
            
            switch (mode) {
                case 'accent-on-bg-off':
                    if (isLightColor) {
                        // Î∞ùÏùÄ ÏÉâÏÉÅÏùº Îïå: ÏÉâÏÉÅ Í∏∞Î∞òÏùò Ïñ¥ÎëêÏö¥ Î∞∞Í≤ΩÏóê Î∞ùÏùÄ ÌÖçÏä§Ìä∏
                        tokens.background = adjustColorLightness(baseColor, 20);
                        tokens.textPrimary = '#ffffff';
                        tokens.fillPrimary = baseColor;
                    } else {
                        // Ïñ¥ÎëêÏö¥ ÏÉâÏÉÅÏùº Îïå: ÏÉâÏÉÅ Í∏∞Î∞òÏùò Î∞ùÏùÄ Î∞∞Í≤ΩÏóê Ïñ¥ÎëêÏö¥ ÌÖçÏä§Ìä∏
                        tokens.background = adjustColorLightness(baseColor, 95);
                        tokens.textPrimary = '#000000';
                        tokens.fillPrimary = baseColor;
                    }
                    break;
                    
                case 'accent-on-bg-fixed':
                    // Ìï≠ÏÉÅ Ìù∞ Î∞∞Í≤Ω
                    tokens.background = '#ffffff';
                    tokens.textPrimary = '#000000';
                    tokens.fillPrimary = baseColor;
                    break;
                    
                case 'accent-off-bg-on':
                    // Î∞∞Í≤ΩÏóê Î©îÏù∏ ÏÉâÏÉÅ ÏÇ¨Ïö©
                    tokens.background = baseColor;
                    tokens.textPrimary = getContrastTextColor(baseColor);
                    tokens.fillPrimary = getLighterShade(baseColor);
                    break;
                    
                case 'accent-on-bg-black':
                    // Ìï≠ÏÉÅ Í≤ÄÏùÄ Î∞∞Í≤Ω
                    tokens.background = '#1f1f1f';
                    tokens.textPrimary = '#ffffff';
                    tokens.fillPrimary = baseColor;
                    break;
            }
            
            return tokens;
        }

        // ÏÉâÏÉÅÏùò Î™ÖÎèÑÎ•º Ï°∞Ï†ïÌïòÎäî Ìó¨Ìçº Ìï®Ïàò
        function adjustColorLightness(hex, targetLightness) {
            const hsl = ColorUtils.hexToHsl ? ColorUtils.hexToHsl(hex) : hexToHsl(hex);
            return ColorUtils.hslToHex ? ColorUtils.hslToHex(hsl[0], hsl[1], targetLightness) : hslToHex(hsl[0], hsl[1], targetLightness);
        }

        // Î∞∞Í≤Ω ÏÉâÏÉÅÏóê ÎåÄÌïú Ï†ÅÏ†àÌïú ÌÖçÏä§Ìä∏ ÏÉâÏÉÅÏùÑ Î∞òÌôòÌïòÎäî Ìï®Ïàò
        function getContrastTextColor(backgroundColor) {
            const hsl = ColorUtils.hexToHsl ? ColorUtils.hexToHsl(backgroundColor) : hexToHsl(backgroundColor);
            return hsl[2] > 50 ? '#000000' : '#ffffff';
        }

        // Îçî Î∞ùÏùÄ ÏÉâÏ°∞Î•º ÏÉùÏÑ±ÌïòÎäî Ìï®Ïàò
        function getLighterShade(baseColor) {
            const hsl = ColorUtils.hexToHsl ? ColorUtils.hexToHsl(baseColor) : hexToHsl(baseColor);
            const lighterLightness = Math.min(hsl[2] + 30, 90);
            const reducedSaturation = Math.max(hsl[1] - 20, 30);
            return ColorUtils.hslToHex ? ColorUtils.hslToHex(hsl[0], reducedSaturation, lighterLightness) : hslToHex(hsl[0], reducedSaturation, lighterLightness);
        }

        // Î∞ùÏùÄ ÏÉâÏÉÅ ÌåêÎã® Ìï®Ïàò (ÏΩîÎìúÎ≤†Ïù¥Ïä§Ïùò isLightRangeÏôÄ ÎèôÏùºÌïú Î°úÏßÅ)
        function isLightColor(hex) {
            if (!hex || !hex.startsWith('#')) return false;
            
            const hsl = ColorUtils.hexToHsl ? ColorUtils.hexToHsl(hex) : hexToHsl(hex);
            const lightness = hsl[2];
            const hue = hsl[0];
            
            // 1) HSL Î∞ùÍ∏∞ Í∏∞Ï§Ä: 80% Ïù¥ÏÉÅ
            if (lightness >= 80) return true;
            
            // 2) BornBright ÏÉâÏÉÅ: Hue 40¬∞-190¬∞ (ÎÖ∏Îûë~Ï≤≠Î°ù Í≥ÑÏó¥)
            if (hue >= 40 && hue <= 190) return true;
            
            return false;
        }

        // ÏÉâÏÉÅ Î∂ÑÎ•ò Ï†ïÎ≥¥Î•º Î∞òÌôòÌïòÎäî Ìï®Ïàò
        function getColorClassification(hex) {
            if (!hex || !hex.startsWith('#')) return null;
            
            const hsl = ColorUtils.hexToHsl ? ColorUtils.hexToHsl(hex) : hexToHsl(hex);
            const lightness = hsl[2];
            const hue = hsl[0];
            const isLight = isLightColor(hex);
            
            let reasons = [];
            if (lightness >= 80) reasons.push(`Î∞ùÍ∏∞ ${Math.round(lightness)}%`);
            if (hue >= 40 && hue <= 190) reasons.push('Î≥∏ÏßàÏ†Å Î∞ùÏùÄ ÏÉâÏÉÅ (ÎÖ∏Îûë~Ï≤≠Î°ù Í≥ÑÏó¥)');
            
            return {
                isLight: isLight,
                lightness: Math.round(lightness),
                hue: Math.round(hue),
                reasons: reasons,
                classification: isLight ? 'Î∞ùÏùÄ Î≤îÏúÑ' : 'Ïñ¥ÎëêÏö¥ Î≤îÏúÑ'
            };
        }

        // ÏÉâÏÉÅ Î∂ÑÎ•ò Ï†ïÎ≥¥ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
        function updateColorClassificationDisplay(hex) {
            const classificationInfo = getColorClassification(hex);
            if (!classificationInfo) return;
            
            const classificationResult = document.getElementById('classificationResult');
            const lightnessValue = document.getElementById('lightnessValue');
            const hueValue = document.getElementById('hueValue');
            const classificationReasons = document.getElementById('classificationReasons');
            
            if (classificationResult) {
                classificationResult.textContent = classificationInfo.classification;
                classificationResult.className = `classification-result ${classificationInfo.isLight ? 'bright' : 'dark'}`;
            }
            
            if (lightnessValue) {
                lightnessValue.textContent = classificationInfo.lightness;
            }
            
            if (hueValue) {
                hueValue.textContent = classificationInfo.hue;
            }
            
            if (classificationReasons) {
                if (classificationInfo.reasons.length > 0) {
                    classificationReasons.textContent = 'Î∂ÑÎ•ò Í∑ºÍ±∞: ' + classificationInfo.reasons.join(', ');
                    classificationReasons.style.display = 'block';
                } else {
                    classificationReasons.style.display = 'none';
                }
            }
        }

        // HSL Î≥ÄÌôò Ìï®ÏàòÎì§ (ColorUtilsÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞ ÎåÄÎπÑ)
        function hexToHsl(hex) {
            const r = parseInt(hex.slice(1, 3), 16) / 255;
            const g = parseInt(hex.slice(3, 5), 16) / 255;
            const b = parseInt(hex.slice(5, 7), 16) / 255;

            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;

            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }

            return [h * 360, s * 100, l * 100];
        }

        function hslToHex(h, s, l) {
            h = h % 360;
            if (h < 0) h += 360;
            s = Math.max(0, Math.min(100, s));
            l = Math.max(0, Math.min(100, l));
            
            h /= 360;
            s /= 100;
            l /= 100;
            
            const a = s * Math.min(l, 1 - l);
            const f = n => {
                const k = (n + h * 12) % 12;
                return l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
            };
            
            const r = Math.round(f(0) * 255);
            const g = Math.round(f(8) * 255);
            const b = Math.round(f(4) * 255);
            
            return "#" + [r, g, b].map(x => {
                const hex = x.toString(16);
                return hex.length === 1 ? "0" + hex : hex;
            }).join("");
        }

        function applyCustomTheme() {
            if (!currentTheme && !wizardThemeData) {
                showMessage('Î®ºÏ†Ä ÌÖåÎßàÎ•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }

            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Î™®ÎìúÎ°ú ÌÖåÎßà ÏóÖÎç∞Ïù¥Ìä∏
            const selectedMode = document.querySelector('.mode-card.selected')?.dataset.mode || 'accent-on-bg-off';
            
            let themeToApply;
            if (currentTheme) {
                // currentTheme ÏÇ¨Ïö© (Ïù¥ÎØ∏ Î≥ÄÏàòÍ∞Ä ÏÉùÏÑ±Îêú Í≤ΩÏö∞)
                themeToApply = {
                    ...currentTheme,
                    applicationMode: selectedMode
                };
            } else {
                // wizardThemeData ÏÇ¨Ïö© (fallback)
                themeToApply = {
                    themeName: wizardThemeData.themeName,
                    baseColor: wizardThemeData.baseColor,
                    applicationMode: selectedMode,
                    scaleColors: { light: generateScaleColors(wizardThemeData.baseColor) }
                };
            }

            parent.postMessage({
                pluginMessage: {
                    type: 'apply-theme-colors-to-frame',
                    theme: themeToApply
                }
            }, '*');
            
            // Ï†ÅÏö©ÌïòÍ∏∞ ÌõÑ annotation ÏûêÎèô ÌôúÏÑ±Ìôî
            const annotationCheckbox = document.getElementById('annotationToggle');
            if (annotationCheckbox) {
                // Ï≤¥ÌÅ¨Î∞ïÏä§ ÌôúÏÑ±Ìôî Î∞è Ï≤¥ÌÅ¨
                annotationCheckbox.disabled = false;
                annotationCheckbox.checked = true;
                
                // ÎùºÎ≤® ÌÖçÏä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                const labelSpan = annotationCheckbox.parentElement.querySelector('span');
                if (labelSpan) {
                    labelSpan.textContent = 'ÏÑ†ÌÉùÎêú ÏöîÏÜåÏùò ÏÉâÏÉÅ Îß§Ìïë ÌëúÏãú';
                    labelSpan.style.color = '#333';
                }
                
                toggleAnnotation(); // annotation ÌôúÏÑ±Ìôî Ìï®Ïàò Ìò∏Ï∂ú
            }
            
            showMessage('Custom Theme Ï†ÅÏö© Ï§ë...');
        }

        function generateScaleColors(baseColor) {
            // Í∏∞Ï°¥ ScaleColorGenerator Î°úÏßÅ ÏÇ¨Ïö©
            const generator = new ScaleColorGenerator();
            return generator.generate(baseColor, 'light');
        }


        // Custom Theme ÏÉùÏÑ±Í∏∞ 
        class CustomThemeGenerator {
            constructor() {
                // Í≥†Ï†ï Îß§ÌïëÎßå ÎÇ®Í∏∞Í∏∞ (preserve tokens)
                this.fixedMappings = {
                    'fill/surface-floating': { light: 900, dark: 900 },
                    'fill/surface-dialog': { light: 50, dark: 75 },
                    'fill/surface-sheet': { light: 50, dark: 75 },
                    'fill/surface-black': { light: 950, dark: 50 },
                    'background/black': { light: 950, dark: 50 },
                    'common/on-white': { light: 50, dark: 950 },
                    'common/on-white-hover': { light: 75, dark: 900 },
                    'common/on-white-pressed': { light: 75, dark: 900 },
                    'common/on-black': { light: 900, dark: 75 },
                    'common/on-black-hover': { light: 950, dark: 50 },
                    'common/on-black-pressed': { light: 950, dark: 50 },
                    'overlay/dimmed': { light: 700, dark: 700 }
                };
            }

            generateTheme(baseHex, themeName, applicationMode, tuningValue = 0) {
                var colorGenerator = new ColorGenerator();
                var lightColors = colorGenerator.generateColors(baseHex, 'light', tuningValue);
                var darkColors = colorGenerator.generateColors(baseHex, 'dark', tuningValue);
                
                // ÏûÖÎ†• ÏÉâÏÉÅÏùò Î™ÖÎèÑÎ°ú closest step Ï∞æÍ∏∞
                var inputHsl = ColorUtils.hexToHsl(baseHex);
                var inputLightness = inputHsl[2];
                var closestStepLight = this.findClosestStep(lightColors, inputLightness);
                var closestStepDark = this.findClosestStep(darkColors, inputLightness);
                
                // ÌÖåÎßà Í∞ùÏ≤¥ ÏÉùÏÑ± (Î∞±ÏóîÎìú ÌòïÏãùÍ≥º ÏùºÏπò)
                return {
                    themeName,
                    baseColor: baseHex,
                    applicationMode,
                    selectedStep: closestStepLight,
                    scaleColors: { 
                        light: lightColors, 
                        dark: darkColors 
                    },
                    // semanticTokensÎäî Î∞±ÏóîÎìúÏóêÏÑú Ï≤òÎ¶¨ÌïòÎØÄÎ°ú Îπà Î∞∞Ïó¥
                    semanticTokens: []
                };
            }
            
            findClosestStep(colors, inputLightness) {
                var closestStep = 500;
                var minDifference = Infinity;
                
                colors.forEach(color => {
                    var colorLightness = ColorUtils.hexToHsl(color.hex)[2];
                    var diff = Math.abs(inputLightness - colorLightness);
                    
                    if (diff < minDifference) {
                        minDifference = diff;
                        closestStep = color.step;
                    }
                });
                
                return closestStep;
            }
        }

        // Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ±
        var colorGenerator = new ColorGenerator();
        var themeGenerator = new CustomThemeGenerator();

        // ÌÉ≠ Ï†ÑÌôò Ìï®Ïàò
        function switchTab(tabName) {
            
            // Î™®Îì† ÌÉ≠ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Î™®Îì† ÌÉ≠ ÏΩòÌÖêÏ∏† Ïà®Í∏∞Í∏∞
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tabName === 'generator') {
                document.getElementById('generatorTab').classList.add('active');
                document.getElementById('generatorContent').classList.add('active');
            } else if (tabName === 'tone-matching') {
                document.getElementById('toneMatchingTab').classList.add('active');
                document.getElementById('toneMatchingContent').classList.add('active');
            } else if (tabName === 'custom-theme') {
                document.getElementById('customThemeTab').classList.add('active');
                document.getElementById('customThemeContent').classList.add('active');
                
                // Custom Theme ÌÉ≠ Ï†ÑÌôò Ïãú ÏÉâÏÉÅ ÎèôÍ∏∞Ìôî Î¶¨Ïä§ÎÑà Îã§Ïãú ÏÑ§Ï†ï
                setTimeout(() => {
                    setupWizardColorSync();
                }, 100);
            }
        }

        // Wizard ÏÉâÏÉÅ ÎèôÍ∏∞Ìôî ÏÑ§Ï†ï Ìï®Ïàò
        function setupWizardColorSync() {
            
            const wizardBaseColor = document.getElementById('wizardThemeBaseColor');
            const wizardBaseHex = document.getElementById('wizardThemeBaseHex');
            
            
            if (wizardBaseColor && wizardBaseHex) {
                
                // Í∏∞Ï°¥ Î¶¨Ïä§ÎÑà Ï†úÍ±∞ (Ï§ëÎ≥µ Î∞©ÏßÄ)
                wizardBaseColor.removeEventListener('input', handleColorPickerChange);
                wizardBaseHex.removeEventListener('input', handleHexInputChange);
                
                // ÏÉà Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
                wizardBaseColor.addEventListener('input', handleColorPickerChange);
                wizardBaseHex.addEventListener('input', handleHexInputChange);
                
                // ÌÖåÏä§Ìä∏Ïö© ÌÅ¥Î¶≠ Î¶¨Ïä§ÎÑàÎèÑ Ï∂îÍ∞Ä
                wizardBaseColor.addEventListener('change', () => {
                });
                
                // Ï¥àÍ∏∞ ÏÉâÏÉÅÏóê ÎåÄÌïú Î∂ÑÎ•ò Ï†ïÎ≥¥ ÌëúÏãú
                const initialColor = wizardBaseColor.value || wizardBaseHex.value;
                if (initialColor) {
                    updateColorClassificationDisplay(initialColor);
                }
                
            } else {
                console.error('‚ùå Wizard color elements not found!');
                document.querySelectorAll('[id*="wizard"]').forEach(el => {
                });
            }
        }

        function handleColorPickerChange() {
            const wizardBaseColor = document.getElementById('wizardThemeBaseColor');
            const wizardBaseHex = document.getElementById('wizardThemeBaseHex');
            
            if (wizardBaseColor && wizardBaseHex) {
                const oldHexValue = wizardBaseHex.value;
                const newColorValue = wizardBaseColor.value.toUpperCase();
                
                
                wizardBaseHex.value = newColorValue;
                
                // Î™®Îìú Ïπ¥Îìú ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
                updateAllModePreviewsWithColor(newColorValue);
                
                // ÏÉâÏÉÅ Î∂ÑÎ•ò Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                updateColorClassificationDisplay(newColorValue);
                
            } else {
                console.error('‚ùå Elements not found in handleColorPickerChange');
            }
        }

        function handleHexInputChange() {
            const wizardBaseColor = document.getElementById('wizardThemeBaseColor');
            const wizardBaseHex = document.getElementById('wizardThemeBaseHex');
            
            if (wizardBaseColor && wizardBaseHex) {
                const hexValue = wizardBaseHex.value;
                
                if (/^#[0-9A-F]{6}$/i.test(hexValue)) {
                    const oldColorValue = wizardBaseColor.value;
                    wizardBaseColor.value = hexValue;
                    
                    // Î™®Îìú Ïπ¥Îìú ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
                    updateAllModePreviewsWithColor(hexValue);
                    
                    // ÏÉâÏÉÅ Î∂ÑÎ•ò Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                    updateColorClassificationDisplay(hexValue);
                    
                } else {
                    console.warn('‚ö†Ô∏è Invalid hex format:', hexValue);
                }
            } else {
                console.error('‚ùå Elements not found in handleHexInputChange');
            }
        }

        // Î™®Îìú ÏÑ§Ï†ï Ìï®Ïàò
        function setMode(mode) {
            currentMode = mode;
            
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            event.target.classList.add('active');
            updateDisplay();
        }

        // ÎîîÏä§ÌîåÎ†àÏù¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updateDisplay() {
            var baseColor = document.getElementById('baseColor');
            if (!baseColor) return;

            var inputHex = baseColor.value;
            var tuningVal = 0;
            
            // Fine Tuning Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
            if (document.getElementById('autoTuning').checked) {
                tuningVal = colorGenerator.getAutoTuningValue(inputHex);
                document.getElementById('tuningSlider').value = tuningVal;
                document.getElementById('tuningValue').textContent = tuningVal;
            } else {
                tuningVal = parseInt(document.getElementById('tuningSlider').value) || 0;
            }
            
            // tuning Í∞íÏùÑ Ìè¨Ìï®ÌïòÏó¨ ÏÉâÏÉÅ ÏÉùÏÑ±
            generatedColors = colorGenerator.generateColors(inputHex, currentMode, tuningVal);
            
            displayColors();
        }

        // ÏÉâÏÉÅ ÌëúÏãú
        function displayColors() {
            var container = document.getElementById('colorResults');
            if (!container) return;

            container.innerHTML = '';
            
            generatedColors.forEach(color => {
                var row = createColorRow(color);
                container.appendChild(row);
            });
        }

        // ÏÉâÏÉÅ Ìñâ ÏÉùÏÑ±
        function createColorRow(color) {
            var row = document.createElement('div');
            row.className = color.isClosest ? 'color-row closest' : 'color-row';
            
            var rgb = ColorUtils.hexToRgb(color.hex);
            var textColor = ColorUtils.getLuminance(rgb.r, rgb.g, rgb.b) > 0.5 ? '#000' : '#fff';
            
            // Ï†ëÍ∑ºÏÑ± Î∞∞ÏßÄ Ï∂îÍ∞Ä
            var badge = '';
            if (color.contrast >= 7) {
                badge = '<span style="background: #28a745; color: white; padding: 1px 4px; border-radius: 2px; font-size: 7px; margin-left: 4px;">AAA</span>';
            } else if (color.contrast >= 4.5) {
                badge = '<span style="background: #ffc107; color: black; padding: 1px 4px; border-radius: 2px; font-size: 7px; margin-left: 4px;">AA</span>';
            } else if (color.contrast >= 3) {
                badge = '<span style="background: #fd7e14; color: white; padding: 1px 4px; border-radius: 2px; font-size: 7px; margin-left: 4px;">A</span>';
            }
            
            row.innerHTML = `
                <div class="color-swatch" style="background: ${color.hex}; color: ${textColor}">
                    ${color.step}${color.isClosest ? ' ‚òÖ' : ''}
                </div>
                <div class="color-info">
                    <span class="color-hex" onclick="copyColor('${color.hex}')">${color.hex.toUpperCase()}</span>
                    <span>${color.contrast.toFixed(2)}:1 ${badge}</span>
                </div>
            `;
            
            return row;
        }

        // Ïä§ÌÖù Î∂ÑÎ•ò ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
        function updateStepIndicator(hex) {
            var stepIndicator = document.getElementById('stepIndicator');
            var classificationBadge = document.getElementById('classificationBadge');
            var classificationInfo = document.getElementById('stepClassificationInfo');
            var classificationText = document.getElementById('stepClassificationText');
            
            var closestStep = ColorUtils.findClosestStep(hex, 'light');
            
            stepIndicator.textContent = `Step: ${closestStep}`;
            
            if (closestStep <= 300) {
                stepIndicator.className = 'step-indicator step-light';
                classificationBadge.textContent = '300 Ïù¥Ìïò';
                classificationBadge.className = 'classification-badge classification-300';
                
                classificationInfo.style.display = 'block';
                classificationText.textContent = `ÏûÖÎ†• ÏÉâÏÉÅÏù¥ Step ${closestStep}Ïóê Ìï¥ÎãπÌï©ÎãàÎã§. Î∞ùÏùÄ ÏÉâÏÉÅ(300 Ïù¥Ìïò)ÏúºÎ°ú Î∂ÑÎ•òÎêòÏñ¥ ModeÎ≥ÑÎ°ú Îã§Î•∏ Îß§ÌïëÏù¥ Ï†ÅÏö©Îê©ÎãàÎã§.`;
            } else if (closestStep >= 400) {
                stepIndicator.className = 'step-indicator step-dark';
                classificationBadge.textContent = '400 Ïù¥ÏÉÅ';
                classificationBadge.className = 'classification-badge classification-400';
                
                classificationInfo.style.display = 'block';
                classificationText.textContent = `ÏûÖÎ†• ÏÉâÏÉÅÏù¥ Step ${closestStep}Ïóê Ìï¥ÎãπÌï©ÎãàÎã§. Ï§ëÍ∞Ñ~Ïñ¥ÎëêÏö¥ ÏÉâÏÉÅ(400 Ïù¥ÏÉÅ)ÏúºÎ°ú Î∂ÑÎ•òÎêòÏñ¥ ModeÎ≥ÑÎ°ú Îã§Î•∏ Îß§ÌïëÏù¥ Ï†ÅÏö©Îê©ÎãàÎã§.`;
            }
        }

        function generateCustomTheme() {
            var baseColor = document.getElementById('themeBaseColor').value;
            var themeName = document.getElementById('themeNameInput').value || 'brand-theme';
            var applicationMode = document.querySelector('input[name="applicationMode"]:checked').value;
            
            // Fine Tuning Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
            var tuningValue = document.getElementById('autoTuning').checked ? 
                colorGenerator.getAutoTuningValue(baseColor) :
                parseInt(document.getElementById('tuningSlider').value) || 0;
            
            
            // themeGeneratorÏóê tuning Í∞í Ï†ÑÎã¨
            currentTheme = themeGenerator.generateTheme(baseColor, themeName, applicationMode, tuningValue);
            
            // Î™®Îìú Ïπ¥Îìú ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
            updateModeCardPreviews();
            
            displayThemePreview(currentTheme);
            
            showMessage(`${themeName} ÌÖåÎßàÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!`);
        }

            function displayThemePreview(theme) {
                var container = document.getElementById('themePreviewContainer');
                
                let modeDescription = '';
                if (theme.applicationMode === 'accent-on-bg-off') {
                    modeDescription = 'Mode 1: Í∞ïÏ°∞ ÏöîÏÜå ON / Î∞∞Í≤Ω ÏöîÏÜå OFF';
                } else if (theme.applicationMode === 'accent-on-bg-fixed') {
                    modeDescription = 'Mode 2: Í∞ïÏ°∞ ÏöîÏÜå ON / Î∞∞Í≤Ω Light Í≥†Ï†ï';
                } else if (theme.applicationMode === 'accent-off-bg-on') {
                    modeDescription = 'Mode 3: Í∞ïÏ°∞ ÏöîÏÜå OFF / Î∞∞Í≤Ω ÏöîÏÜå ON';
                } else if (theme.applicationMode === 'accent-on-bg-black') {
                    modeDescription = 'Mode 4: Í∞ïÏ°∞ ÏöîÏÜå ON / Î∞∞Í≤Ω Dark Í≥†Ï†ï';
                }
                
                container.innerHTML = `
                    <div style="background: #e8f5e8; border: 1px solid #d4edda; border-radius: 4px; padding: 8px; margin-top: 8px;">
                        <p style="font-size: 10px; color: #155724; margin: 0;">
                            <strong>Ï†ÅÏö©Îêú Mode:</strong> ${modeDescription}<br>
                            <strong>Closest Step:</strong> Light: ${theme.selectedStep || 'N/A'}, Dark: ${theme.selectedStep || 'N/A'}
                        </p>
                    </div>
                    
                    <button class="action-btn btn-success" onclick="createCustomThemeVariables()">
                        Î™®Îì† ÌÖåÎßà Î≥ÄÏàò ÏÉùÏÑ±
                    </button>
                    
                    <div style="margin-top: 8px;">
                        <button class="action-btn btn-secondary" onclick="applyCustomMode('CustomLight')" style="width: 100%;">
                            Custom Theme Ï†ÅÏö©ÌïòÍ∏∞
                        </button>
                    </div>
                `;
            }

        function createCustomThemeVariables() {
            if (!currentTheme) {
                showMessage('Î®ºÏ†Ä ÌÖåÎßàÎ•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            
            parent.postMessage({
                pluginMessage: {
                    type: 'create-custom-theme',
                    theme: currentTheme
                }
            }, '*');
            
            showMessage('Custom Theme Variables ÏÉùÏÑ± Ï§ë...');
        }

        // Custom Mode Ï†ÅÏö© Ìï®Ïàò
        function applyCustomMode(modeName) {
            
            if (!currentTheme) {
                showMessage('Î®ºÏ†Ä ÌÖåÎßàÎ•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            parent.postMessage({
                pluginMessage: {
                    type: 'apply-theme-colors-to-frame',
                    theme: currentTheme
                }
            }, '*');
            
            showMessage('ÌÖåÎßà ÌÜ†ÌÅ∞ÏùÑ FrameÏóê Ï†ÅÏö© Ï§ë...');
        }
        // ÏïÑÏΩîÎîîÏñ∏ ÌÜ†Í∏Ä Ìï®Ïàò Ï∂îÍ∞Ä
        function toggleThemePreview() {
        var header = document.getElementById('themePreviewAccordion');
        var content = document.getElementById('themePreviewContent');
        
        header.classList.toggle('active');
        content.classList.toggle('expanded');
        }
        // ÏÉâÏÉÅ Î≥µÏÇ¨
        function copyColor(hex) {
            // ÌÅ¥Î¶≠Îêú ÏöîÏÜå Ï∞æÍ∏∞
            var elements = document.querySelectorAll('.color-hex');
            elements.forEach(function(el) {
                if (el.textContent === hex.toUpperCase()) {
                    el.classList.add('copied');
                    setTimeout(function() {
                        el.classList.remove('copied');
                    }, 500);
                }
            });
            
            navigator.clipboard.writeText(hex).then(function() {
                showMessage(`üìã ${hex} Î≥µÏÇ¨Îê®!`);
            }).catch(function() {
                showMessage('Î≥µÏÇ¨ Ïã§Ìå®');
            });
        }

        // Î≥ÄÏàò ÏÉùÏÑ± Ìï®ÏàòÎì§
function createVariables() {
    var variableName = document.getElementById('variableName').value.trim();
    
    if (!variableName) {
        showMessage('Î≥ÄÏàò Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
        return;
    }
    
    if (generatedColors.length === 0) {
        showMessage('Î®ºÏ†Ä ÏÉâÏÉÅÏùÑ ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî!');
        return;
    }

    // Fine Tuning Í∞í Ìè¨Ìï®
    var tuningValue = document.getElementById('autoTuning').checked ? 
        colorGenerator.getAutoTuningValue(document.getElementById('baseColor').value) :
        parseInt(document.getElementById('tuningSlider').value) || 0;

    parent.postMessage({
        pluginMessage: {
            type: 'create-variables',
            colors: generatedColors,
            variableName: variableName,
            mode: currentMode,
            dualMode: false,
            tuningValue: tuningValue  // Ï∂îÍ∞Ä
        }
    }, '*');
    
    showMessage('Variables ÏÉùÏÑ± Ï§ë...');
}

function createDualModeVariables() {
    var variableName = document.getElementById('variableName').value.trim();
    
    if (!variableName) {
        showMessage('Î≥ÄÏàò Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
        return;
    }

    var baseColor = document.getElementById('baseColor').value;
    
    // Fine Tuning Í∞í Ìè¨Ìï®
    var tuningValue = document.getElementById('autoTuning').checked ? 
        colorGenerator.getAutoTuningValue(baseColor) :
        parseInt(document.getElementById('tuningSlider').value) || 0;
    
    // Light Î™®Îìú ÏÉâÏÉÅ ÏÉùÏÑ± (tuning Í∞í Ìè¨Ìï®)
    var lightColors = colorGenerator.generateColors(baseColor, 'light', tuningValue);
    // Dark Î™®Îìú ÏÉâÏÉÅ ÏÉùÏÑ± (tuning Í∞í Ìè¨Ìï®)
    var darkColors = colorGenerator.generateColors(baseColor, 'dark', tuningValue);
    
    parent.postMessage({
        pluginMessage: {
            type: 'create-variables',
            lightColors: lightColors,
            darkColors: darkColors,
            variableName: variableName,
            dualMode: true,
            tuningValue: tuningValue  // Ï∂îÍ∞Ä
        }
    }, '*');
    
    showMessage('Light + Dark Variables ÏÉùÏÑ± Ï§ë...');
}

function createStyles() {
    var variableName = document.getElementById('variableName').value.trim() || 'color';
    
    if (generatedColors.length === 0) {
        showMessage('Î®ºÏ†Ä ÏÉâÏÉÅÏùÑ ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî!');
        return;
    }

    parent.postMessage({
        pluginMessage: {
            type: 'create-styles',
            colors: generatedColors,
            styleName: variableName,
            mode: currentMode
        }
    }, '*');
    
    showMessage('Color Styles ÏÉùÏÑ± Ï§ë...');
}

// Î©îÏãúÏßÄ ÏàòÏã† Ï≤òÎ¶¨ ÏàòÏ†ï
window.addEventListener('message', (event) => {
    var msg = event.data.pluginMessage;
    if (!msg) return;

    
    switch(msg.type) {
        case 'plugin-ready':
            break;
        case 'variable-created':
            if (msg.success) {
                var modeText = msg.dualMode ? 'Light + Dark' : currentMode;
                showMessage(`‚úÖ ${msg.count}Í∞úÏùò ${modeText} Variables ÏÉùÏÑ± ÏôÑÎ£å!`);
            } else {
                showMessage('ÏóêÎü¨: ' + msg.error);
            }
            break;
        case 'style-created':
            if (msg.success) {
                showMessage(`‚úÖ ${msg.count}Í∞úÏùò Color Styles ÏÉùÏÑ± ÏôÑÎ£å!`);
            } else {
                showMessage('ÏóêÎü¨: ' + msg.error);
            }
            break;
        case 'custom-theme-created':
            if (msg.success) {
                showMessage(`${msg.themeName} ÌÖåÎßà ÏÉùÏÑ± ÏôÑÎ£å! (${msg.count || 0}Í∞ú Î≥ÄÏàò)`);
            } else {
                showMessage('ÌÖåÎßà ÏÉùÏÑ± ÏóêÎü¨: ' + msg.error);
            }
            break;
        case 'custom-mode-applied':
            if (msg.success) {
                var message = msg.modeName + ' Î™®Îìú Ï†ÅÏö© ÏôÑÎ£å!';
                if (msg.cleared && msg.cleared > 0) {
                    message += ' (' + msg.count + 'Í∞ú Ï†ÅÏö©, ' + msg.cleared + 'Í∞ú ÏûêÏãù ÏÉÅÏÜç)';
                } else {
                    message += ' (' + msg.count + 'Í∞ú Ï†ÅÏö©)';
                }
                showMessage(message);
            } else {
                showMessage('Î™®Îìú Ï†ÅÏö© ÏóêÎü¨: ' + msg.error);
            }
            break;
        case 'error':
            showMessage('ÏóêÎü¨: ' + msg.message);
            break;
    }
});

        // ÌÜ§ Îß§Ïπ≠ Í¥ÄÎ†® Ìï®ÏàòÎì§
        function setReferenceColor() {
            var picker = document.getElementById('referenceColorPicker');
            var hex = document.getElementById('referenceColorHex');
            
            referenceColor = {
                hex: picker.value.toUpperCase(),
                hsl: ColorUtils.hexToHsl(picker.value)
            };
            
            updateReferenceDisplay();
            showMessage('Í∏∞Ï§Ä ÏÉâÏÉÅÏù¥ ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§!');
        }

        function clearReference() {
            referenceColor = null;
            updateReferenceDisplay();
            clearToneMatchingResults();
            showMessage('Í∏∞Ï§Ä ÏÉâÏÉÅÏù¥ Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.');
        }

        function updateReferenceDisplay() {
            var statusElement = document.getElementById('referenceStatus');
            var displayElement = document.getElementById('referenceDisplay');
            
            if (!referenceColor) {
                statusElement.textContent = 'ÌòÑÏû¨ ÏÑ§Ï†ïÎêú Í∏∞Ï§Ä Ïª¨Îü¨Í∞Ä ÏóÜÏäµÎãàÎã§.';
                statusElement.style.color = '#666';
                displayElement.innerHTML = '';
                return;
            }
            
            statusElement.textContent = `‚úÖ Reference Set: ${referenceColor.hex}`;
            statusElement.style.color = '#28a745';
            
            var [h, s, l] = referenceColor.hsl;
            displayElement.innerHTML = `
                <div class="reference-display">
                    <div class="reference-color" style="background: ${referenceColor.hex};"></div>
                    <div class="reference-info">
                        <h4>üìå Reference Active</h4>
                        <p><strong>${referenceColor.hex}</strong></p>
                        <p>HSL(${Math.round(h)}¬∞, ${Math.round(s)}%, ${Math.round(l)}%)</p>
                    </div>
                </div>
            `;
        }

        function generateToneMatching() {
            if (!referenceColor) {
                showMessage('Î®ºÏ†Ä Í∏∞Ï§Ä ÏÉâÏÉÅÏùÑ ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            var newColorHex = document.getElementById('newColorPicker').value;
            
            // Î∞±ÏóîÎìúÏóê ÌÜ§ Îß§Ïπ≠ ÏöîÏ≤≠
            parent.postMessage({
                pluginMessage: {
                    type: 'generate-tone-matching',
                    referenceColor: referenceColor.hex,
                    inputColor: newColorHex
                }
            }, '*');
            
            showMessage('ÌÜ§ Îß§Ïπ≠ Ï†úÏïàÏùÑ ÏÉùÏÑ±ÌïòÎäî Ï§ë...');
        }

        function displayToneMatchingSuggestions(originalHex, suggestions) {
            var container = document.getElementById('toneMatchingResults');
            
            container.innerHTML = `
                <div style="background: white; border: 2px solid #17a2b8; border-radius: 6px; padding: 12px; margin: 8px 0;">
                    <h4 style="color: #17a2b8; margin-bottom: 8px; font-size: 11px;">üé® Tone Matching Results</h4>
                    <p style="margin-bottom: 8px; font-size: 9px;">
                        Original: <strong>${originalHex.toUpperCase()}</strong><br>
                        ‚Üí Adjusted to match reference tone:
                    </p>
                    
                    <div class="tone-suggestions">
                        ${suggestions.map((suggestion, index) => `
                            <div class="tone-suggestion" onclick="applyToneToGenerator('${suggestion.hex}')">
                                <div class="tone-color-display" style="background: ${suggestion.hex};"></div>
                                <div class="tone-suggestion-title">${suggestion.type}</div>
                                <div class="tone-suggestion-hex">${suggestion.hex.toUpperCase()}</div>
                                <div class="tone-suggestion-desc">${suggestion.explanation}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="info-box">
                    <h5>üí° Tone Matching:</h5>
                    <p>‚Ä¢ Ï†úÏïàÏùÄ Í∏∞Ï§Ä ÏÉâÏÉÅÏùò ÌÜ§Í≥º Îß§Ïπ≠Îê©ÎãàÎã§.<br>
                    ‚Ä¢ ÏÉâÏÉÅÏùÑ ÌÅ¥Î¶≠ÌïòÎ©¥ Scale GeneratorÏóê Ï†ÅÏö©Îê©ÎãàÎã§.<br>
                    ‚Ä¢ ÏùºÍ¥ÄÎêú Î∏åÎûúÎìú ÌÜ§ÏúºÎ°ú 13Îã®Í≥Ñ Ïä§ÏºÄÏùº ÏÉùÏÑ±Ïù¥ Í∞ÄÎä•Ìï©ÎãàÎã§.</p>
                </div>
            `;
        }

        function applyToneToGenerator(hex) {
            switchTab('generator');
            document.getElementById('baseColor').value = hex;
            document.getElementById('hexInput').value = hex.toUpperCase();
            updateDisplay();
            showMessage(`${hex} ÏÉâÏÉÅÏù¥ GeneratorÏóê Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§!`);
        }

        function clearToneMatchingResults() {
            var container = document.getElementById('toneMatchingResults');
            if (container) container.innerHTML = '';
        }

        // Î©îÏãúÏßÄ ÌëúÏãú
        function showMessage(message) {
            var el = document.getElementById('successMessage');
            if (el) {
                el.textContent = message;
                el.classList.add('show');
                setTimeout(() => el.classList.remove('show'), 3000);
            }
        }

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        function setupEventListeners() {

            // ÌÉ≠ Î≤ÑÌäºÎì§
            const generatorTab = document.getElementById('generatorTab');
            const toneMatchingTab = document.getElementById('toneMatchingTab');
            const customThemeTab = document.getElementById('customThemeTab');
            
            if (generatorTab) {
                generatorTab.addEventListener('click', () => switchTab('generator'));
            } else {
                console.warn('generatorTab not found');
            }
            
            if (toneMatchingTab) {
                toneMatchingTab.addEventListener('click', () => switchTab('tone-matching'));
            } else {
                console.warn('toneMatchingTab not found');
            }
            
            if (customThemeTab) {
                customThemeTab.addEventListener('click', () => switchTab('custom-theme'));
            } else {
                console.warn('customThemeTab not found');
            }

            // ÏÉâÏÉÅ ÏûÖÎ†•
            var baseColor = document.getElementById('baseColor');
            var hexInput = document.getElementById('hexInput');

            if (baseColor && hexInput) {
                baseColor.addEventListener('input', () => {
                    hexInput.value = baseColor.value.toUpperCase();
                    updateDisplay();
                    // Î™®Îìú ÎØ∏Î¶¨Î≥¥Í∏∞ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                    if (document.getElementById('wizardStep3').classList.contains('active')) {
                        updateAllModePreviewsWithColor(baseColor.value);
                    }
                });

                hexInput.addEventListener('input', () => {
                    if (/^#[0-9A-F]{6}$/i.test(hexInput.value)) {
                        baseColor.value = hexInput.value;
                        updateDisplay();
                        // Î™®Îìú ÎØ∏Î¶¨Î≥¥Í∏∞ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                        if (document.getElementById('wizardStep3').classList.contains('active')) {
                            updateAllModePreviewsWithColor(hexInput.value);
                        }
                    }
                });
            }

            // Fine Tuning Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
            var autoTuning = document.getElementById('autoTuning');
            var tuningSlider = document.getElementById('tuningSlider');
            var tuningValue = document.getElementById('tuningValue');
            var tuningStatus = document.getElementById('tuningStatus');

            if (autoTuning && tuningSlider && tuningValue && tuningStatus) {
                autoTuning.addEventListener('change', function() {
                if (this.checked) {
                    // Auto Î™®Îìú
                    var baseColor = document.getElementById('baseColor').value;
                    var autoValue = colorGenerator.getAutoTuningValue(baseColor);
                    tuningSlider.value = autoValue;
                    tuningSlider.disabled = true;
                    tuningValue.textContent = autoValue;
                    tuningStatus.textContent = 'Auto: ' + autoValue;
                    tuningStatus.className = 'auto';
                } else {
                    // Manual Î™®Îìú
                    tuningSlider.disabled = false;
                    tuningStatus.textContent = 'Manual: ' + tuningSlider.value;
                    tuningStatus.className = '';
                }
                updateDisplay();
            });

                tuningSlider.addEventListener('input', function() {
                    if (!autoTuning.checked) {
                        tuningValue.textContent = this.value;
                        tuningStatus.textContent = 'Manual: ' + this.value;
                        updateDisplay();
                    }
                });
            } else {
                console.warn('Fine Tuning elements not found');
            }

            // ÌÜ§ Îß§Ïπ≠ Í¥ÄÎ†®
            const setRefBtn = document.getElementById('setRefBtn');
            const clearRefBtn = document.getElementById('clearRefBtn');
            const getSuggestionsBtn = document.getElementById('getSuggestionsBtn');
            
            if (setRefBtn) {
                setRefBtn.addEventListener('click', setReferenceColor);
            } else {
                console.warn('setRefBtn not found');
            }
            
            if (clearRefBtn) {
                clearRefBtn.addEventListener('click', clearReference);
            } else {
                console.warn('clearRefBtn not found');
            }
            
            if (getSuggestionsBtn) {
                getSuggestionsBtn.addEventListener('click', generateToneMatching);
            } else {
                console.warn('getSuggestionsBtn not found');
            }

            // Reference ÏÉâÏÉÅ ÏûÖÎ†• ÎèôÍ∏∞Ìôî
            var refPicker = document.getElementById('referenceColorPicker');
            var refHex = document.getElementById('referenceColorHex');
            
            if (refPicker && refHex) {
                refPicker.addEventListener('input', () => {
                    refHex.value = refPicker.value.toUpperCase();
                });
                
                refHex.addEventListener('input', () => {
                    if (/^#[0-9A-F]{6}$/i.test(refHex.value)) {
                        refPicker.value = refHex.value;
                    }
                });
            } else {
                console.warn('Reference color elements not found');
            }

            // New ÏÉâÏÉÅ ÏûÖÎ†• ÎèôÍ∏∞Ìôî
            var newPicker = document.getElementById('newColorPicker');
            var newHex = document.getElementById('newColorHex');
            
            if (newPicker && newHex) {
                newPicker.addEventListener('input', () => {
                    newHex.value = newPicker.value.toUpperCase();
                });
                
                newHex.addEventListener('input', () => {
                    if (/^#[0-9A-F]{6}$/i.test(newHex.value)) {
                        newPicker.value = newHex.value;
                    }
                });
            } else {
                console.warn('New color elements not found');
            }

            // Custom Theme Í¥ÄÎ†® (Íµ¨Î≤ÑÏ†Ñ)
            var themeBaseColor = document.getElementById('themeBaseColor');
            var themeBaseHex = document.getElementById('themeBaseHex');
            
            if (themeBaseColor && themeBaseHex) {
                themeBaseColor.addEventListener('input', () => {
                    themeBaseHex.value = themeBaseColor.value.toUpperCase();
                    updateStepIndicator(themeBaseColor.value);
                });
                
                themeBaseHex.addEventListener('input', () => {
                    if (/^#[0-9A-F]{6}$/i.test(themeBaseHex.value)) {
                        themeBaseColor.value = themeBaseHex.value;
                        updateStepIndicator(themeBaseHex.value);
                    }
                });
            } else {
                console.warn('Custom Theme (old version) elements not found');
            }

            // Radio button Ïä§ÌÉÄÏùº ÏóÖÎç∞Ïù¥Ìä∏
            document.querySelectorAll('input[name="applicationMode"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    document.querySelectorAll('.radio-option').forEach(option => {
                        option.classList.remove('selected');
                    });
                    e.target.parentElement.classList.add('selected');
                });
            });

            // Wizard Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
            
            // Step 1 ÏÉâÏÉÅ ÏûÖÎ†• ÎèôÍ∏∞Ìôî
            setupWizardColorSync();
            
            // Mode Ïπ¥Îìú ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
            document.querySelectorAll('.mode-card').forEach(card => {
                card.addEventListener('click', () => {
                    const mode = card.dataset.mode;
                    selectModeCard(card, mode);
                });
            });

            // Ï¥àÍ∏∞Ìôî ÏôÑÎ£å
        }

        // ÌîåÎü¨Í∑∏Ïù∏ Î©îÏãúÏßÄ ÏàòÏã†
        window.addEventListener('message', (event) => {
            var msg = event.data.pluginMessage;
            if (!msg) return;

                    
            switch(msg.type) {
                case 'plugin-ready':
                            break;
                case 'variable-created':
                    if (msg.success) {
                        showMessage(`Variables ÏÉùÏÑ± ÏôÑÎ£å! (${msg.count || 0}Í∞ú)`);
                    } else {
                        showMessage('ÏóêÎü¨: ' + msg.error);
                    }
                    break;
                case 'custom-theme-created':
                    if (msg.success) {
                        showMessage(`${msg.themeName} ÌÖåÎßà ÏÉùÏÑ± ÏôÑÎ£å! (${msg.count || 0}Í∞ú Î≥ÄÏàò)`);
                    } else {
                        showMessage('ÌÖåÎßà ÏÉùÏÑ± ÏóêÎü¨: ' + msg.error);
                    }
                    break;
                case 'custom-mode-applied':
                    if (msg.success) {
                        var message = msg.modeName + ' Î™®Îìú Ï†ÅÏö© ÏôÑÎ£å!';
                        if (msg.cleared && msg.cleared > 0) {
                            message += ' (' + msg.count + 'Í∞ú Ï†ÅÏö©, ' + msg.cleared + 'Í∞ú ÏûêÏãù ÏÉÅÏÜç)';
                        } else {
                            message += ' (' + msg.count + 'Í∞ú Ï†ÅÏö©)';
                        }
                        showMessage(message);
                    } else {
                        showMessage('Î™®Îìú Ï†ÅÏö© ÏóêÎü¨: ' + msg.error);
                    }
                    break;
                case 'tone-matching-complete':
                    displayToneMatchingSuggestions(msg.originalColor, msg.suggestions);
                    showMessage('ÌÜ§ Îß§Ïπ≠ Ï†úÏïàÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!');
                    break;
                case 'tone-matching-error':
                    showMessage('ÌÜ§ Îß§Ïπ≠ ÏóêÎü¨: ' + msg.error);
                    break;
                case 'error':
                    showMessage('ÏóêÎü¨: ' + msg.message);
                    break;
            }
        });

        // Ï¥àÍ∏∞Ìôî
        function init() {
            setupEventListeners();
            updateDisplay();
            
            // Custom Theme ÌÉ≠Ïù¥ Í∏∞Î≥∏Ïù¥ÎØÄÎ°ú Ï¥àÍ∏∞Ìôî ÏãúÏóêÎèÑ wizard ÏÉâÏÉÅ ÎèôÍ∏∞Ìôî ÏÑ§Ï†ï
            setTimeout(() => {
                setupWizardColorSync();
            }, 200);
            
        }
        
        // =====================================
        // Annotation Ï†úÏñ¥ Ìï®ÏàòÎì§
        // =====================================
        
        function showMappingInfo() {
            // ÌòÑÏû¨ ÌÖåÎßà Ï†ïÎ≥¥ÏôÄ Ìï®Íªò Î©îÏãúÏßÄ Ï†ÑÏÜ°
            parent.postMessage({
                pluginMessage: {
                    type: 'annotation-control',
                    action: 'show-mapping',
                    theme: currentTheme // ÌòÑÏû¨ ÌÖåÎßà Ï†ïÎ≥¥ Ìè¨Ìï®
                }
            }, '*');
        }
        
        // Mapping Ï†ïÎ≥¥ ÌëúÏãú ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        function updateMappingStatus(message, color = '#666') {
            const statusSpan = document.getElementById('mappingStatus');
            if (statusSpan) {
                statusSpan.textContent = message;
                statusSpan.style.color = color;
            }
        }

        // DOM Î°úÎìú ÏôÑÎ£å ÌõÑ Ï¥àÍ∏∞Ìôî
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú ÏôÑÎ£å ÌõÑÏóêÎèÑ ÌôïÏù∏
        window.addEventListener('load', () => {
            if (generatedColors.length === 0) {
                updateDisplay();
            }
        });
    </script>